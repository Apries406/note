<!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title></title>
    </head>
    <body>
    <div class="markdown-body"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre>code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上一小节我们介绍完了关于模版是如何编译成 <code>AST</code> 的结构的，接下来进入模版编译的第二步 <code>transform</code>，<code>transform</code> 的目标是为了生成 <code>JavaScript AST</code>。因为渲染函数是一堆 <code>js</code> 代码构成的，编译器最终产物就是渲染函数，所以理想中的 <code>AST</code> 应该是用来描述渲染函数的 <code>JS</code> 代码。</p>
<p>那么接下来，我们一起看看 <code>transfrom</code> 转换的实现细节吧！</p>
<h2 data-id="heading-1">Transform</h2>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">function</span> <span class="hljs-title function_">baseCompile</span>(<span class="hljs-params">template, options</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-keyword">const</span> isModuleMode = options.<span class="hljs-property">mode</span> === <span class="hljs-string">'module'</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-comment">// 用来标记代码生成模式</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">  <span class="hljs-keyword">const</span> prefixIdentifiers =</span>
<span class="code-block-extension-codeLine" data-line-num="5">    !__BROWSER__ &amp;&amp; (options.<span class="hljs-property">prefixIdentifiers</span> === <span class="hljs-literal">true</span> || isModuleMode)</span>
<span class="code-block-extension-codeLine" data-line-num="6">  <span class="hljs-comment">// 获取节点和指令转换的方法</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">  <span class="hljs-keyword">const</span> [nodeTransforms, directiveTransforms] = <span class="hljs-title function_">getBaseTransformPreset</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="8">  <span class="hljs-comment">// AST 转换成 Javascript AST</span></span>
<span class="code-block-extension-codeLine" data-line-num="9">  <span class="hljs-title function_">transform</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="10">    ast,</span>
<span class="code-block-extension-codeLine" data-line-num="11">    <span class="hljs-title function_">extend</span>({}, options, {</span>
<span class="code-block-extension-codeLine" data-line-num="12">      prefixIdentifiers,</span>
<span class="code-block-extension-codeLine" data-line-num="13">      <span class="hljs-attr">nodeTransforms</span>: [</span>
<span class="code-block-extension-codeLine" data-line-num="14">        ...nodeTransforms,</span>
<span class="code-block-extension-codeLine" data-line-num="15">        ...(options.<span class="hljs-property">nodeTransforms</span> || [])</span>
<span class="code-block-extension-codeLine" data-line-num="16">      ],</span>
<span class="code-block-extension-codeLine" data-line-num="17">      <span class="hljs-attr">directiveTransforms</span>: <span class="hljs-title function_">extend</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="18">        {},</span>
<span class="code-block-extension-codeLine" data-line-num="19">        directiveTransforms,</span>
<span class="code-block-extension-codeLine" data-line-num="20">        options.<span class="hljs-property">directiveTransforms</span> || {}</span>
<span class="code-block-extension-codeLine" data-line-num="21">      )</span>
<span class="code-block-extension-codeLine" data-line-num="22">    })</span>
<span class="code-block-extension-codeLine" data-line-num="23">  )</span>
<span class="code-block-extension-codeLine" data-line-num="24">}</span>
</code></pre>
<p>其中第一个参数 <code>prefixIdentifiers</code> 是用于标记前缀代码生成模式的。举个例子，以下代码：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">html</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-html code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="2">  {{msg}}</span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<p>在 <code>module</code> 模式下，生成的渲染函数是一个通过 <code>with(_ctx) { ... }</code> 包裹后的，大致为：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-keyword">with</span> (_ctx) {</span>
<span class="code-block-extension-codeLine" data-line-num="3">    <span class="hljs-keyword">const</span> { toDisplayString, openBlock, createElementBlock } = <span class="hljs-title class_">Vue</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="hljs-keyword">return</span> (<span class="hljs-title function_">openBlock</span>(), <span class="hljs-title function_">createElementBlock</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, <span class="hljs-title function_">toDisplayString</span>(msg), <span class="hljs-number">1</span> <span class="hljs-comment">/* TEXT */</span>))</span>
<span class="code-block-extension-codeLine" data-line-num="5">  }</span>
<span class="code-block-extension-codeLine" data-line-num="6">}</span>
</code></pre>
<p>而在 <code>function</code> 模式下，生成的渲染函数中的动态内容，则会被转成 <code>_ctx.msg</code> 的模式：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> { toDisplayString, openBlock, createElementBlock } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span></span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-keyword">return</span> (<span class="hljs-title function_">openBlock</span>(), <span class="hljs-title function_">createElementBlock</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, <span class="hljs-title function_">toDisplayString</span>(ctx.<span class="hljs-property">msg</span>), <span class="hljs-number">1</span> <span class="hljs-comment">/* TEXT */</span>))</span>
<span class="code-block-extension-codeLine" data-line-num="4">}</span>
</code></pre>
<p>而参数 <code>nodeTransforms</code> 和 <code>directiveTransforms</code> 对象则是由 <code>getBaseTransformPreset</code> 生成的一系列预设函数：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getBaseTransformPreset</span>(<span class="hljs-params">prefixIdentifiers</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-keyword">return</span> [</span>
<span class="code-block-extension-codeLine" data-line-num="3">    [</span>
<span class="code-block-extension-codeLine" data-line-num="4">      transformOnce,</span>
<span class="code-block-extension-codeLine" data-line-num="5">      transformIf,</span>
<span class="code-block-extension-codeLine" data-line-num="6">      transformFor,</span>
<span class="code-block-extension-codeLine" data-line-num="7">      transformExpression,</span>
<span class="code-block-extension-codeLine" data-line-num="8">      transformSlotOutlet,</span>
<span class="code-block-extension-codeLine" data-line-num="9">      transformElement,</span>
<span class="code-block-extension-codeLine" data-line-num="10">      trackSlotScopes,</span>
<span class="code-block-extension-codeLine" data-line-num="11">      transformText</span>
<span class="code-block-extension-codeLine" data-line-num="12">    ],</span>
<span class="code-block-extension-codeLine" data-line-num="13">    {</span>
<span class="code-block-extension-codeLine" data-line-num="14">      <span class="hljs-attr">on</span>: transformOn,</span>
<span class="code-block-extension-codeLine" data-line-num="15">      <span class="hljs-attr">bind</span>: transformBind,</span>
<span class="code-block-extension-codeLine" data-line-num="16">      <span class="hljs-attr">model</span>: transformModel</span>
<span class="code-block-extension-codeLine" data-line-num="17">    }</span>
<span class="code-block-extension-codeLine" data-line-num="18">  ]</span>
<span class="code-block-extension-codeLine" data-line-num="19">}</span>
</code></pre>
<p><code>nodeTransforms</code> 涵盖了特殊节点的转换函数，比如文本节点、<code>v-if</code> 节点等等， <code>directiveTransforms</code> 则包含了一些指令的转换函数。</p>
<p>这些转换函数的细节，不是这里的核心，我们将在下文进行几个重点函数的介绍，其余的有兴趣的小伙伴可以自行翻阅 <code>vue3</code> 源码查看实现的细节。接下来我们将核心介绍 <code>transform</code> 函数的实现：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">root, options</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-comment">// 生成 transform 上下文</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-keyword">const</span> context = <span class="hljs-title function_">createTransformContext</span>(root, options)</span>
<span class="code-block-extension-codeLine" data-line-num="4">  <span class="hljs-comment">// 遍历处理 ast 节点</span></span>
<span class="code-block-extension-codeLine" data-line-num="5">  <span class="hljs-title function_">traverseNode</span>(root, context)</span>
<span class="code-block-extension-codeLine" data-line-num="6">  <span class="hljs-comment">// 静态提升</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">  <span class="hljs-keyword">if</span> (options.<span class="hljs-property">hoistStatic</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-title function_">hoistStatic</span>(root, context)</span>
<span class="code-block-extension-codeLine" data-line-num="9">  }</span>
<span class="code-block-extension-codeLine" data-line-num="10">  <span class="hljs-comment">// 创建根代码生成节点</span></span>
<span class="code-block-extension-codeLine" data-line-num="11">  <span class="hljs-keyword">if</span> (!options.<span class="hljs-property">ssr</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="12">    <span class="hljs-title function_">createRootCodegen</span>(root, context)</span>
<span class="code-block-extension-codeLine" data-line-num="13">  }</span>
<span class="code-block-extension-codeLine" data-line-num="14">  <span class="hljs-comment">// 最终确定元信息</span></span>
<span class="code-block-extension-codeLine" data-line-num="15">  root.<span class="hljs-property">helpers</span> = [...context.<span class="hljs-property">helpers</span>.<span class="hljs-title function_">keys</span>()]</span>
<span class="code-block-extension-codeLine" data-line-num="16">  root.<span class="hljs-property">components</span> = [...context.<span class="hljs-property">components</span>]</span>
<span class="code-block-extension-codeLine" data-line-num="17">  root.<span class="hljs-property">directives</span> = [...context.<span class="hljs-property">directives</span>]</span>
<span class="code-block-extension-codeLine" data-line-num="18">  root.<span class="hljs-property">imports</span> = context.<span class="hljs-property">imports</span></span>
<span class="code-block-extension-codeLine" data-line-num="19">  root.<span class="hljs-property">hoists</span> = context.<span class="hljs-property">hoists</span></span>
<span class="code-block-extension-codeLine" data-line-num="20">  root.<span class="hljs-property">temps</span> = context.<span class="hljs-property">temps</span></span>
<span class="code-block-extension-codeLine" data-line-num="21">  root.<span class="hljs-property">cached</span> = context.<span class="hljs-property">cached</span></span>
<span class="code-block-extension-codeLine" data-line-num="22">}</span>
</code></pre>
<h2 data-id="heading-2">1. 生成 transform 上下文</h2>
<p>在正式开始 <code>transform</code> 前，需要创建生成一个 <code>transformContext</code>，即 <code>transform</code> 上下文。</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createTransformContext</span>(<span class="hljs-params">root, TransformOptions</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-keyword">const</span> context = {</span>
<span class="code-block-extension-codeLine" data-line-num="3">    <span class="hljs-comment">// 选项配置</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">    hoistStatic,</span>
<span class="code-block-extension-codeLine" data-line-num="5">    cacheHandlers,</span>
<span class="code-block-extension-codeLine" data-line-num="6">    nodeTransforms,</span>
<span class="code-block-extension-codeLine" data-line-num="7">    directiveTransforms,</span>
<span class="code-block-extension-codeLine" data-line-num="8">    transformHoist,</span>
<span class="code-block-extension-codeLine" data-line-num="9">    <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="10">    <span class="hljs-comment">// 状态数据</span></span>
<span class="code-block-extension-codeLine" data-line-num="11">    root,</span>
<span class="code-block-extension-codeLine" data-line-num="12">    <span class="hljs-attr">helpers</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="13">    <span class="hljs-attr">components</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="14">    <span class="hljs-attr">directives</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="15">    <span class="hljs-attr">hoists</span>: [],</span>
<span class="code-block-extension-codeLine" data-line-num="16">    <span class="hljs-comment">// ....</span></span>
<span class="code-block-extension-codeLine" data-line-num="17">    <span class="hljs-comment">// 一些函数</span></span>
<span class="code-block-extension-codeLine" data-line-num="18">    <span class="hljs-title function_">helper</span>(<span class="hljs-params">name</span>) {},</span>
<span class="code-block-extension-codeLine" data-line-num="19">    <span class="hljs-title function_">removeHelper</span>(<span class="hljs-params">name</span>) {},</span>
<span class="code-block-extension-codeLine" data-line-num="20">    <span class="hljs-title function_">helperString</span>(<span class="hljs-params">name</span>) {},</span>
<span class="code-block-extension-codeLine" data-line-num="21">    <span class="hljs-title function_">replaceNode</span>(<span class="hljs-params">node</span>) {},</span>
<span class="code-block-extension-codeLine" data-line-num="22">    <span class="hljs-title function_">removeNode</span>(<span class="hljs-params">node</span>) {},</span>
<span class="code-block-extension-codeLine" data-line-num="23">    <span class="hljs-attr">onNodeRemoved</span>: <span class="hljs-function">() =&gt;</span> {},</span>
<span class="code-block-extension-codeLine" data-line-num="24">    <span class="hljs-title function_">addIdentifiers</span>(<span class="hljs-params">exp</span>) {},</span>
<span class="code-block-extension-codeLine" data-line-num="25">    <span class="hljs-title function_">removeIdentifiers</span>(<span class="hljs-params">exp</span>) {},</span>
<span class="code-block-extension-codeLine" data-line-num="26">    <span class="hljs-title function_">hoist</span>(<span class="hljs-params">exp</span>) {},</span>
<span class="code-block-extension-codeLine" data-line-num="27">    <span class="hljs-title function_">cache</span>(<span class="hljs-params">exp, isVNode = <span class="hljs-literal">false</span></span>) {}</span>
<span class="code-block-extension-codeLine" data-line-num="28">  }</span>
<span class="code-block-extension-codeLine" data-line-num="29"></span>
<span class="code-block-extension-codeLine" data-line-num="30">  <span class="hljs-keyword">return</span> context</span>
<span class="code-block-extension-codeLine" data-line-num="31">}</span>
</code></pre>
<p>可以看到这个上下文对象 <code>context</code> 内主要包含三部分：<code>tansform</code> 过程中的一些配置属性，一些状态数据，以及在 <code>transform</code> 过程中可能会调用的一些辅助函数。</p>
<h2 data-id="heading-3">2. 遍历AST节点</h2>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">traverseNode</span>(<span class="hljs-params">node, context</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  context.<span class="hljs-property">currentNode</span> = node</span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-comment">// 节点转换函数</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">  <span class="hljs-keyword">const</span> { nodeTransforms } = context</span>
<span class="code-block-extension-codeLine" data-line-num="5">  <span class="hljs-keyword">const</span> exitFns = []</span>
<span class="code-block-extension-codeLine" data-line-num="6">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; nodeTransforms.<span class="hljs-property">length</span>; i++) {</span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-comment">// 执行节点转换函数，返回得到一个退出函数</span></span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-keyword">const</span> onExit = nodeTransforms[i](node, context)</span>
<span class="code-block-extension-codeLine" data-line-num="9">    <span class="hljs-comment">// 收集所有退出函数</span></span>
<span class="code-block-extension-codeLine" data-line-num="10">    <span class="hljs-keyword">if</span> (onExit) {</span>
<span class="code-block-extension-codeLine" data-line-num="11">      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isArray</span>(onExit)) {</span>
<span class="code-block-extension-codeLine" data-line-num="12">        exitFns.<span class="hljs-title function_">push</span>(...onExit)</span>
<span class="code-block-extension-codeLine" data-line-num="13">      } <span class="hljs-keyword">else</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="14">        exitFns.<span class="hljs-title function_">push</span>(onExit)</span>
<span class="code-block-extension-codeLine" data-line-num="15">      }</span>
<span class="code-block-extension-codeLine" data-line-num="16">    }</span>
<span class="code-block-extension-codeLine" data-line-num="17">    <span class="hljs-keyword">if</span> (!context.<span class="hljs-property">currentNode</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="18">      <span class="hljs-comment">// 节点被移除</span></span>
<span class="code-block-extension-codeLine" data-line-num="19">      <span class="hljs-keyword">return</span></span>
<span class="code-block-extension-codeLine" data-line-num="20">    } <span class="hljs-keyword">else</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="21">      node = context.<span class="hljs-property">currentNode</span></span>
<span class="code-block-extension-codeLine" data-line-num="22">    }</span>
<span class="code-block-extension-codeLine" data-line-num="23">  }</span>
<span class="code-block-extension-codeLine" data-line-num="24"></span>
<span class="code-block-extension-codeLine" data-line-num="25">  <span class="hljs-keyword">switch</span> (node.<span class="hljs-property">type</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="26">    <span class="hljs-keyword">case</span> <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">COMMENT</span>:</span>
<span class="code-block-extension-codeLine" data-line-num="27">      <span class="hljs-keyword">if</span> (!context.<span class="hljs-property">ssr</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="28">        <span class="hljs-comment">// context 中 helpers 添加 CREATE_COMMENT 辅助函数</span></span>
<span class="code-block-extension-codeLine" data-line-num="29">        context.<span class="hljs-title function_">helper</span>(<span class="hljs-variable constant_">CREATE_COMMENT</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="30">      }</span>
<span class="code-block-extension-codeLine" data-line-num="31">      <span class="hljs-keyword">break</span></span>
<span class="code-block-extension-codeLine" data-line-num="32">    <span class="hljs-keyword">case</span> <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">INTERPOLATION</span>:</span>
<span class="code-block-extension-codeLine" data-line-num="33">      <span class="hljs-comment">// context 中 helpers 添加 TO_DISPLAY_STRING 辅助函数</span></span>
<span class="code-block-extension-codeLine" data-line-num="34">      <span class="hljs-keyword">if</span> (!context.<span class="hljs-property">ssr</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="35">        context.<span class="hljs-title function_">helper</span>(<span class="hljs-variable constant_">TO_DISPLAY_STRING</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="36">      }</span>
<span class="code-block-extension-codeLine" data-line-num="37">      <span class="hljs-keyword">break</span></span>
<span class="code-block-extension-codeLine" data-line-num="38">    <span class="hljs-keyword">case</span> <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">IF</span>:</span>
<span class="code-block-extension-codeLine" data-line-num="39">      <span class="hljs-comment">// 递归遍历每个分支节点</span></span>
<span class="code-block-extension-codeLine" data-line-num="40">      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; node.<span class="hljs-property">branches</span>.<span class="hljs-property">length</span>; i++) {</span>
<span class="code-block-extension-codeLine" data-line-num="41">        <span class="hljs-title function_">traverseNode</span>(node.<span class="hljs-property">branches</span>[i], context)</span>
<span class="code-block-extension-codeLine" data-line-num="42">      }</span>
<span class="code-block-extension-codeLine" data-line-num="43">      <span class="hljs-keyword">break</span></span>
<span class="code-block-extension-codeLine" data-line-num="44">    <span class="hljs-keyword">case</span> <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">IF_BRANCH</span>:</span>
<span class="code-block-extension-codeLine" data-line-num="45">    <span class="hljs-keyword">case</span> <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">FOR</span>:</span>
<span class="code-block-extension-codeLine" data-line-num="46">    <span class="hljs-keyword">case</span> <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">ELEMENT</span>:</span>
<span class="code-block-extension-codeLine" data-line-num="47">    <span class="hljs-keyword">case</span> <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">ROOT</span>:</span>
<span class="code-block-extension-codeLine" data-line-num="48">      <span class="hljs-comment">// 遍历子节点</span></span>
<span class="code-block-extension-codeLine" data-line-num="49">      <span class="hljs-title function_">traverseChildren</span>(node, context)</span>
<span class="code-block-extension-codeLine" data-line-num="50">      <span class="hljs-keyword">break</span></span>
<span class="code-block-extension-codeLine" data-line-num="51">  }</span>
<span class="code-block-extension-codeLine" data-line-num="52">  </span>
<span class="code-block-extension-codeLine" data-line-num="53">  context.<span class="hljs-property">currentNode</span> = node</span>
<span class="code-block-extension-codeLine" data-line-num="54">  <span class="hljs-comment">// 执行上面收集到的所有退出函数</span></span>
<span class="code-block-extension-codeLine" data-line-num="55">  <span class="hljs-keyword">let</span> i = exitFns.<span class="hljs-property">length</span></span>
<span class="code-block-extension-codeLine" data-line-num="56">  <span class="hljs-keyword">while</span> (i--) {</span>
<span class="code-block-extension-codeLine" data-line-num="57">    exitFns[i]()</span>
<span class="code-block-extension-codeLine" data-line-num="58">  }</span>
<span class="code-block-extension-codeLine" data-line-num="59">}</span>
</code></pre>
<p><code>traverseNode</code> 递归的遍历 <code>ast</code> 中的每个节点，然后执行一些转换函数 <code>nodeTransforms</code>，这些转换函数就是我们上面介绍的通过 <code>getBaseTransformPreset</code> 生成的对象，值得注意的是：<code>nodeTransforms</code> 返回的是一个数组，说明这些转换函数是有序的，顺序代表着优先级关系，比如对于<code>if</code>的处理优先级就比 <code>for</code> 要高，因为如果条件不满足很可能有大部分内容都没必要进行转换。</p>
<p>另外，如果转换函数执行完成后，有返回退出函数 <code>onExit</code> 的话，那么会被统一存贮到 <code>exitFns</code> 当中，在所有字节点处理完成统一执行调用。</p>
<h3 data-id="heading-4">transformElement</h3>
<p>根据上文我们知道了对节点进行处理，就是通过一系列函数对节点的的各个部分的内容分别进行处理。鉴于这些函数很多内容也很庞杂，我们拿其中一个函数<code>transformElement</code>进行分析，理解对<strong>AST</strong>的转化过程：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">transformElement</span> = (<span class="hljs-params">node, context</span>) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-comment">// 这里就是返回了一个退出函数</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">postTransformElement</span>(<span class="hljs-params"></span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="5">    node.<span class="hljs-property">codegenNode</span> = <span class="hljs-title function_">createVNodeCall</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="6">      context,</span>
<span class="code-block-extension-codeLine" data-line-num="7">      vnodeTag,</span>
<span class="code-block-extension-codeLine" data-line-num="8">      vnodeProps,</span>
<span class="code-block-extension-codeLine" data-line-num="9">      vnodeChildren,</span>
<span class="code-block-extension-codeLine" data-line-num="10">      vnodePatchFlag,</span>
<span class="code-block-extension-codeLine" data-line-num="11">      vnodeDynamicProps,</span>
<span class="code-block-extension-codeLine" data-line-num="12">      vnodeDirectives,</span>
<span class="code-block-extension-codeLine" data-line-num="13">      !!shouldUseBlock,</span>
<span class="code-block-extension-codeLine" data-line-num="14">      <span class="hljs-literal">false</span> <span class="hljs-comment">/* disableTracking */</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="15">      isComponent,</span>
<span class="code-block-extension-codeLine" data-line-num="16">      node.<span class="hljs-property">loc</span></span>
<span class="code-block-extension-codeLine" data-line-num="17">    )</span>
<span class="code-block-extension-codeLine" data-line-num="18">  }</span>
<span class="code-block-extension-codeLine" data-line-num="19">}</span>
</code></pre>
<p>可以看到，<code>transformElement</code> 的核心目的就是通过调用<code>createVNodeCall</code>函数获取 <code>VNodeCall</code> 对象，并赋值给 <code>node.codegenNode</code>。</p>
<p>到这里，我们就大致明白了，我们前面一直提到需要把 <code>AST</code> 转成 <code>JavaScript AST</code>，实际上就是给 <code>AST</code> 的<code>codegenNode</code> 属性赋值。接下来，我们接着看 <code>createVNodeCall</code> 函数的实现：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createVNodeCall</span>(<span class="hljs-params">context, tag, props, children, patchFlag, dynamicProps, directives, isBlock = <span class="hljs-literal">false</span>, disableTracking = <span class="hljs-literal">false</span>, loc = locStub</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-keyword">if</span> (context) {</span>
<span class="code-block-extension-codeLine" data-line-num="3">    <span class="hljs-keyword">if</span> (isBlock) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">      context.<span class="hljs-title function_">helper</span>(<span class="hljs-variable constant_">OPEN_BLOCK</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="5">      context.<span class="hljs-title function_">helper</span>(<span class="hljs-title function_">getVNodeBlockHelper</span>(context.<span class="hljs-property">inSSR</span>, isComponent))</span>
<span class="code-block-extension-codeLine" data-line-num="6">    } <span class="hljs-keyword">else</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="7">      context.<span class="hljs-title function_">helper</span>(<span class="hljs-title function_">getVNodeHelper</span>(context.<span class="hljs-property">inSSR</span>, isComponent))</span>
<span class="code-block-extension-codeLine" data-line-num="8">    }</span>
<span class="code-block-extension-codeLine" data-line-num="9">    <span class="hljs-keyword">if</span> (directives) {</span>
<span class="code-block-extension-codeLine" data-line-num="10">      context.<span class="hljs-title function_">helper</span>(<span class="hljs-variable constant_">WITH_DIRECTIVES</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="11">    }</span>
<span class="code-block-extension-codeLine" data-line-num="12">  }</span>
<span class="code-block-extension-codeLine" data-line-num="13"></span>
<span class="code-block-extension-codeLine" data-line-num="14">  <span class="hljs-keyword">return</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="15">    <span class="hljs-attr">type</span>: <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">VNODE_CALL</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="16">    tag,</span>
<span class="code-block-extension-codeLine" data-line-num="17">    props,</span>
<span class="code-block-extension-codeLine" data-line-num="18">    children,</span>
<span class="code-block-extension-codeLine" data-line-num="19">    patchFlag,</span>
<span class="code-block-extension-codeLine" data-line-num="20">    dynamicProps,</span>
<span class="code-block-extension-codeLine" data-line-num="21">    directives,</span>
<span class="code-block-extension-codeLine" data-line-num="22">    isBlock,</span>
<span class="code-block-extension-codeLine" data-line-num="23">    disableTracking,</span>
<span class="code-block-extension-codeLine" data-line-num="24">    loc</span>
<span class="code-block-extension-codeLine" data-line-num="25">  }</span>
<span class="code-block-extension-codeLine" data-line-num="26">}</span>
</code></pre>
<p>该函数也非常容易理解，本质就是为了返回一个 <code>VNodeCall</code> 对象，该对象是用来描述 <code>js</code> 代码的。</p>
<p>这里的函数 <code>context.helper</code> 是会把一些 <code>Symbol</code> 对象添加到 <code>context.helpers Set</code> 的数据结构当中，在接下来的代码生成阶段，会判断当前 <code>JS AST</code> 中是否存在 <code>helpers</code> 内容，如果存在，则会根据 <code>helpers</code> 中标记的 <code>Symbol</code> 对象，来生成辅助函数。</p>
<p>接下来看一下之前的这样一个 <code>demo</code></p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">html</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-html code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-comment">&lt;!-- 这是一段注释 --&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ msg }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="4"><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<p>经过遍历<code>AST</code>节点 <code>traverseNode</code> 函数调用之后之后的结果大致如下：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">json</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-json code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-punctuation">{</span></span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="hljs-punctuation">{</span></span>
<span class="code-block-extension-codeLine" data-line-num="5">      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="6">      <span class="hljs-attr">"ns"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">      <span class="hljs-attr">"tag"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"p"</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="8">      <span class="hljs-attr">"tagType"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="9">      <span class="hljs-attr">"props"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="10">      <span class="hljs-attr">"isSelfClosing"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="11">      <span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="12">      <span class="hljs-attr">"loc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="13">      <span class="hljs-attr">"codegenNode"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></span>
<span class="code-block-extension-codeLine" data-line-num="14">        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">13</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="15">        <span class="hljs-attr">"tag"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\"p\""</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="16">        <span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></span>
<span class="code-block-extension-codeLine" data-line-num="17">          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="18">          <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></span>
<span class="code-block-extension-codeLine" data-line-num="19">            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="20">            <span class="hljs-attr">"isStatic"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="21">            <span class="hljs-attr">"constType"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="22">            <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"msg"</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="23">            <span class="hljs-attr">"loc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></span>
<span class="code-block-extension-codeLine" data-line-num="24">              <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="25">              <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="26">              <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"msg"</span></span>
<span class="code-block-extension-codeLine" data-line-num="27">            <span class="hljs-punctuation">}</span></span>
<span class="code-block-extension-codeLine" data-line-num="28">          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="29">          <span class="hljs-attr">"loc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></span>
<span class="code-block-extension-codeLine" data-line-num="30">            <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="31">            <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="32">            <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{{ msg }}"</span></span>
<span class="code-block-extension-codeLine" data-line-num="33">          <span class="hljs-punctuation">}</span></span>
<span class="code-block-extension-codeLine" data-line-num="34">        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="35">        <span class="hljs-attr">"patchFlag"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1 /* TEXT */"</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="36">        <span class="hljs-attr">"isBlock"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="37">        <span class="hljs-attr">"disableTracking"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="38">        <span class="hljs-attr">"isComponent"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="39">        <span class="hljs-attr">"loc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></span>
<span class="code-block-extension-codeLine" data-line-num="40">          <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="41">          <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="42">          <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;p&gt;{{ msg }}&lt;/p&gt;"</span></span>
<span class="code-block-extension-codeLine" data-line-num="43">        <span class="hljs-punctuation">}</span></span>
<span class="code-block-extension-codeLine" data-line-num="44">      <span class="hljs-punctuation">}</span></span>
<span class="code-block-extension-codeLine" data-line-num="45">    <span class="hljs-punctuation">}</span></span>
<span class="code-block-extension-codeLine" data-line-num="46">  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="47">  <span class="hljs-attr">"helpers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="48">  <span class="hljs-attr">"components"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="49">  <span class="hljs-attr">"directives"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="50">  <span class="hljs-attr">"hoists"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="51">  <span class="hljs-attr">"imports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="52">  <span class="hljs-attr">"cached"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="53">  <span class="hljs-attr">"temps"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="54">  <span class="hljs-attr">"loc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></span>
<span class="code-block-extension-codeLine" data-line-num="55">    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="56">    <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="57">    <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\n  &lt;p&gt;{{ msg }}&lt;/p&gt;\n"</span></span>
<span class="code-block-extension-codeLine" data-line-num="58">  <span class="hljs-punctuation">}</span></span>
<span class="code-block-extension-codeLine" data-line-num="59"><span class="hljs-punctuation">}</span></span>
</code></pre>
<p>可以看到，相比原节点，转换后的节点无论是在语义化还是在信息上，都更加丰富，我们可以依据它在代码生成阶段生成所需的代码。</p>
<h2 data-id="heading-5">3. 静态提升</h2>
<p>经过上一步的遍历 <code>AST</code> 节点后，我们接着来看一下静态提升做了哪些工作。</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">hoistStatic</span>(<span class="hljs-params">root, context</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-title function_">walk</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="3">    root,</span>
<span class="code-block-extension-codeLine" data-line-num="4">    context,</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-comment">// 根节点是不可提升的</span></span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="hljs-title function_">isSingleElementRoot</span>(root, root.<span class="hljs-property">children</span>[<span class="hljs-number">0</span>])</span>
<span class="code-block-extension-codeLine" data-line-num="7">  )</span>
<span class="code-block-extension-codeLine" data-line-num="8">}</span>
</code></pre>
<p><code>hoistStatic</code> 核心调用的就是 <code>walk</code> 函数：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">function</span> <span class="hljs-title function_">walk</span>(<span class="hljs-params">node, context, doNotHoistNode = <span class="hljs-literal">false</span></span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-keyword">const</span> { children } = node</span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-comment">// 记录那些被静态提升的节点数量</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">  <span class="hljs-keyword">let</span> hoistedCount = <span class="hljs-number">0</span></span>
<span class="code-block-extension-codeLine" data-line-num="5"></span>
<span class="code-block-extension-codeLine" data-line-num="6">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; children.<span class="hljs-property">length</span>; i++) {</span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-keyword">const</span> child = children[i]</span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-comment">// 普通元素节点可以被提升</span></span>
<span class="code-block-extension-codeLine" data-line-num="9">    <span class="hljs-keyword">if</span> (</span>
<span class="code-block-extension-codeLine" data-line-num="10">      child.<span class="hljs-property">type</span> === <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">ELEMENT</span> &amp;&amp;</span>
<span class="code-block-extension-codeLine" data-line-num="11">      child.<span class="hljs-property">tagType</span> === <span class="hljs-title class_">ElementTypes</span>.<span class="hljs-property">ELEMENT</span></span>
<span class="code-block-extension-codeLine" data-line-num="12">    ) {</span>
<span class="code-block-extension-codeLine" data-line-num="13">      <span class="hljs-comment">// 根据 doNotHoistNode 判断是否可以提升</span></span>
<span class="code-block-extension-codeLine" data-line-num="14">      <span class="hljs-comment">// 设置 constantType 的值</span></span>
<span class="code-block-extension-codeLine" data-line-num="15">      <span class="hljs-keyword">const</span> constantType = doNotHoistNode</span>
<span class="code-block-extension-codeLine" data-line-num="16">        ? <span class="hljs-title class_">ConstantTypes</span>.<span class="hljs-property">NOT_CONSTANT</span></span>
<span class="code-block-extension-codeLine" data-line-num="17">        : <span class="hljs-title function_">getConstantType</span>(child, context)</span>
<span class="code-block-extension-codeLine" data-line-num="18">      <span class="hljs-comment">// constantType = CAN_SKIP_PATCH || CAN_HOIST || CAN_STRINGIFY</span></span>
<span class="code-block-extension-codeLine" data-line-num="19">      <span class="hljs-keyword">if</span> (constantType &gt; <span class="hljs-title class_">ConstantTypes</span>.<span class="hljs-property">NOT_CONSTANT</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="20">        <span class="hljs-comment">// constantType = CAN_HOIST || CAN_STRINGIFY</span></span>
<span class="code-block-extension-codeLine" data-line-num="21">        <span class="hljs-keyword">if</span> (constantType &gt;= <span class="hljs-title class_">ConstantTypes</span>.<span class="hljs-property">CAN_HOIST</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="22">          <span class="hljs-comment">// 可提升状态中，codegenNode = PatchFlags.HOISTED</span></span>
<span class="code-block-extension-codeLine" data-line-num="23">          child.<span class="hljs-property">codegenNode</span>.<span class="hljs-property">patchFlag</span> =</span>
<span class="code-block-extension-codeLine" data-line-num="24">            <span class="hljs-title class_">PatchFlags</span>.<span class="hljs-property">HOISTED</span> + (__DEV__ ? <span class="hljs-string">` /* HOISTED */`</span> : <span class="hljs-string">``</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="25">  </span>
<span class="code-block-extension-codeLine" data-line-num="26">          <span class="hljs-comment">// 提升节点，将节点存储到 转换上下文context 的 hoist 数组中</span></span>
<span class="code-block-extension-codeLine" data-line-num="27">          child.<span class="hljs-property">codegenNode</span> = context.<span class="hljs-title function_">hoist</span>(child.<span class="hljs-property">codegenNode</span>!)</span>
<span class="code-block-extension-codeLine" data-line-num="28">          <span class="hljs-comment">// 提升节点数量自增 1</span></span>
<span class="code-block-extension-codeLine" data-line-num="29">          hoistedCount++</span>
<span class="code-block-extension-codeLine" data-line-num="30">          <span class="hljs-keyword">continue</span></span>
<span class="code-block-extension-codeLine" data-line-num="31">        }</span>
<span class="code-block-extension-codeLine" data-line-num="32">      } <span class="hljs-keyword">else</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="33">        <span class="hljs-comment">// 动态子节点可能存在一些静态可提升的属性</span></span>
<span class="code-block-extension-codeLine" data-line-num="34">        <span class="hljs-keyword">const</span> codegenNode = child.<span class="hljs-property">codegenNode</span>!</span>
<span class="code-block-extension-codeLine" data-line-num="35">        <span class="hljs-keyword">if</span> (codegenNode.<span class="hljs-property">type</span> === <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">VNODE_CALL</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="36">          <span class="hljs-comment">// 判断 props 是否可提升</span></span>
<span class="code-block-extension-codeLine" data-line-num="37">          <span class="hljs-keyword">const</span> flag = <span class="hljs-title function_">getPatchFlag</span>(codegenNode)</span>
<span class="code-block-extension-codeLine" data-line-num="38">          <span class="hljs-keyword">if</span> (</span>
<span class="code-block-extension-codeLine" data-line-num="39">            (!flag ||</span>
<span class="code-block-extension-codeLine" data-line-num="40">              flag === <span class="hljs-title class_">PatchFlags</span>.<span class="hljs-property">NEED_PATCH</span> ||</span>
<span class="code-block-extension-codeLine" data-line-num="41">              flag === <span class="hljs-title class_">PatchFlags</span>.<span class="hljs-property">TEXT</span>) &amp;&amp;</span>
<span class="code-block-extension-codeLine" data-line-num="42">            <span class="hljs-title function_">getGeneratedPropsConstantType</span>(child, context) &gt;=</span>
<span class="code-block-extension-codeLine" data-line-num="43">              <span class="hljs-title class_">ConstantTypes</span>.<span class="hljs-property">CAN_HOIST</span></span>
<span class="code-block-extension-codeLine" data-line-num="44">          ) {</span>
<span class="code-block-extension-codeLine" data-line-num="45">            <span class="hljs-comment">// 提升 props</span></span>
<span class="code-block-extension-codeLine" data-line-num="46">            <span class="hljs-keyword">const</span> props = <span class="hljs-title function_">getNodeProps</span>(child)</span>
<span class="code-block-extension-codeLine" data-line-num="47">            <span class="hljs-keyword">if</span> (props) {</span>
<span class="code-block-extension-codeLine" data-line-num="48">              codegenNode.<span class="hljs-property">props</span> = context.<span class="hljs-title function_">hoist</span>(props)</span>
<span class="code-block-extension-codeLine" data-line-num="49">            }</span>
<span class="code-block-extension-codeLine" data-line-num="50">          }</span>
<span class="code-block-extension-codeLine" data-line-num="51">          <span class="hljs-comment">// 将节点的动态 props 添加到转换上下文对象中</span></span>
<span class="code-block-extension-codeLine" data-line-num="52">          <span class="hljs-keyword">if</span> (codegenNode.<span class="hljs-property">dynamicProps</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="53">            codegenNode.<span class="hljs-property">dynamicProps</span> = context.<span class="hljs-title function_">hoist</span>(codegenNode.<span class="hljs-property">dynamicProps</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="54">          }</span>
<span class="code-block-extension-codeLine" data-line-num="55">        }</span>
<span class="code-block-extension-codeLine" data-line-num="56">      }</span>
<span class="code-block-extension-codeLine" data-line-num="57">    }</span>
<span class="code-block-extension-codeLine" data-line-num="58"></span>
<span class="code-block-extension-codeLine" data-line-num="59">    <span class="hljs-keyword">if</span> (child.<span class="hljs-property">type</span> === <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">ELEMENT</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="60">      <span class="hljs-comment">// 组件是 slot 的情况</span></span>
<span class="code-block-extension-codeLine" data-line-num="61">      <span class="hljs-keyword">const</span> isComponent = child.<span class="hljs-property">tagType</span> === <span class="hljs-title class_">ElementTypes</span>.<span class="hljs-property">COMPONENT</span></span>
<span class="code-block-extension-codeLine" data-line-num="62">      <span class="hljs-keyword">if</span> (isComponent) {</span>
<span class="code-block-extension-codeLine" data-line-num="63">        context.<span class="hljs-property">scopes</span>.<span class="hljs-property">vSlot</span>++</span>
<span class="code-block-extension-codeLine" data-line-num="64">      }</span>
<span class="code-block-extension-codeLine" data-line-num="65">      <span class="hljs-comment">// 如果节点类型是组件，则进行递归判断操作</span></span>
<span class="code-block-extension-codeLine" data-line-num="66">      <span class="hljs-title function_">walk</span>(child, context)</span>
<span class="code-block-extension-codeLine" data-line-num="67">      <span class="hljs-keyword">if</span> (isComponent) {</span>
<span class="code-block-extension-codeLine" data-line-num="68">        context.<span class="hljs-property">scopes</span>.<span class="hljs-property">vSlot</span>--</span>
<span class="code-block-extension-codeLine" data-line-num="69">      }</span>
<span class="code-block-extension-codeLine" data-line-num="70">    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (child.<span class="hljs-property">type</span> === <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">FOR</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="71">      <span class="hljs-comment">// 再循环节点中，只有一个子节点的情况下，不需要提升</span></span>
<span class="code-block-extension-codeLine" data-line-num="72">      <span class="hljs-title function_">walk</span>(child, context, child.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> === <span class="hljs-number">1</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="73">    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (child.<span class="hljs-property">type</span> === <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">IF</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="74">      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; child.<span class="hljs-property">branches</span>.<span class="hljs-property">length</span>; i++) {</span>
<span class="code-block-extension-codeLine" data-line-num="75">        <span class="hljs-comment">// 在 v-if 这样的条件节点上，如果也只有一个分支逻辑的情况</span></span>
<span class="code-block-extension-codeLine" data-line-num="76">        <span class="hljs-title function_">walk</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="77">          child.<span class="hljs-property">branches</span>[i],</span>
<span class="code-block-extension-codeLine" data-line-num="78">          context,</span>
<span class="code-block-extension-codeLine" data-line-num="79">          child.<span class="hljs-property">branches</span>[i].<span class="hljs-property">children</span>.<span class="hljs-property">length</span> === <span class="hljs-number">1</span></span>
<span class="code-block-extension-codeLine" data-line-num="80">        )</span>
<span class="code-block-extension-codeLine" data-line-num="81">      }</span>
<span class="code-block-extension-codeLine" data-line-num="82">    }</span>
<span class="code-block-extension-codeLine" data-line-num="83">  }</span>
<span class="code-block-extension-codeLine" data-line-num="84">  <span class="hljs-comment">// 预字符串化</span></span>
<span class="code-block-extension-codeLine" data-line-num="85">  <span class="hljs-keyword">if</span> (hoistedCount &amp;&amp; context.<span class="hljs-property">transformHoist</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="86">    context.<span class="hljs-title function_">transformHoist</span>(children, context, node)</span>
<span class="code-block-extension-codeLine" data-line-num="87">  }</span>
<span class="code-block-extension-codeLine" data-line-num="88">  <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="89">}</span>
</code></pre>
<p>该函数看起来比较复杂，其实就是通过 <code>walk</code> 这个递归函数，不断的判断节点是否符合可以静态提升的条件：只有普通的元素节点是可以提升的。</p>
<p>如果满足条件，则会给节点的 <code>codegenNode</code> 属性中的 <code>patchFlag</code> 的值设置成 <code>PatchFlags.HOISTED</code>。</p>
<p>接着执行转换器上下文中的 <code>context.hoist</code> 方法：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hoist</span>(<span class="hljs-params">exp</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-comment">// 存储到 hoists 数组中</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">  context.<span class="hljs-property">hoists</span>.<span class="hljs-title function_">push</span>(exp);</span>
<span class="code-block-extension-codeLine" data-line-num="4">  <span class="hljs-keyword">const</span> identifier = <span class="hljs-title function_">createSimpleExpression</span>(<span class="hljs-string">`_hoisted_<span class="hljs-subst">${context.hoists.length}</span>`</span>, <span class="hljs-literal">false</span>, exp.<span class="hljs-property">loc</span>, <span class="hljs-literal">true</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="5">  identifier.<span class="hljs-property">hoisted</span> = exp</span>
<span class="code-block-extension-codeLine" data-line-num="6">  <span class="hljs-keyword">return</span> identifier</span>
<span class="code-block-extension-codeLine" data-line-num="7">}</span>
</code></pre>
<p>该函数的作用就是将这个可以被提升的节点存储到转换上下文 <code>context</code> 的 <code>hoist</code> 数组中。这个数据就是用来存储那些可被提升节点的列表。</p>
<p>接下来，我们再来说一下，为什么要做静态提升呢？ 如下模板所示：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">html</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-html code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>text<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<p>在没有被提升的情况下其渲染函数相当于：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> { createElementVNode <span class="hljs-keyword">as</span> _createElementVNode, openBlock <span class="hljs-keyword">as</span> _openBlock, createElementBlock <span class="hljs-keyword">as</span> _createElementBlock } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span></span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx, _cache, $props, $setup, $data, $options</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  <span class="hljs-keyword">return</span> (<span class="hljs-title function_">_openBlock</span>(), <span class="hljs-title function_">_createElementBlock</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, [</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-title function_">_createElementVNode</span>(<span class="hljs-string">"p"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"text"</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="6">  ]))</span>
<span class="code-block-extension-codeLine" data-line-num="7">}</span>
</code></pre>
<p>很明显，<code>p</code>&nbsp;标签是静态的，它不会改变。但是如上渲染函数的问题也很明显，如果组件内存在动态的内容，当渲染函数重新执行时，即使&nbsp;<code>p</code>&nbsp;标签是静态的，那么它对应的&nbsp;<code>VNode</code>&nbsp;也会重新创建。</p>
<p><strong>所谓的 “静态提升”，就是将一些静态的节点或属性提升到渲染函数之外</strong>。如下面的代码所示：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> { createElementVNode <span class="hljs-keyword">as</span> _createElementVNode, openBlock <span class="hljs-keyword">as</span> _openBlock, createElementBlock <span class="hljs-keyword">as</span> _createElementBlock } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span></span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">const</span> _hoisted_1 = <span class="hljs-comment">/*#__PURE__*/</span><span class="hljs-title function_">_createElementVNode</span>(<span class="hljs-string">"p"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"text"</span>, -<span class="hljs-number">1</span> <span class="hljs-comment">/* HOISTED */</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="4"><span class="hljs-keyword">const</span> _hoisted_2 = [</span>
<span class="code-block-extension-codeLine" data-line-num="5">  _hoisted_1</span>
<span class="code-block-extension-codeLine" data-line-num="6">]</span>
<span class="code-block-extension-codeLine" data-line-num="7"></span>
<span class="code-block-extension-codeLine" data-line-num="8"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx, _cache, $props, $setup, $data, $options</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="9">  <span class="hljs-keyword">return</span> (<span class="hljs-title function_">_openBlock</span>(), <span class="hljs-title function_">_createElementBlock</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, _hoisted_2))</span>
<span class="code-block-extension-codeLine" data-line-num="10">}</span>
</code></pre>
<p>这就实现了减少&nbsp;<code>VNode</code>&nbsp;创建的性能消耗。</p>
<p>而这里的静态提升步骤生成的 <code>hoists</code>，会在 <code>codegenNode</code> 会在生成代码阶段帮助我们生成静态提升的相关代码。</p>
<h3 data-id="heading-6">预字符串化</h3>
<p>注意到在 <code>walk</code> 函数结束时，进行了静态提升节点的 <code>预字符串化</code>。什么是预字符串化呢？一起来看个示例：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">xml</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-xml code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">  ... 共 20+ 节点</span>
<span class="code-block-extension-codeLine" data-line-num="4">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="5"><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<p>对于这样有大量静态提升的模版场景，如果不考虑 <code>预字符串化</code> 那么生成的渲染函数将会包含大量的 <code>createElementVNode</code> 函数：假设如上模板中有大量连续的静态的 <code>p</code> 标签，此时渲染函数生成的结果如下：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">php</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-php code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">_hoisted_1</span> = <span class="hljs-comment">/*#__PURE__*/</span><span class="hljs-title function_ invoke__">_createElementVNode</span>(<span class="hljs-string">"p"</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, -<span class="hljs-number">1</span> <span class="hljs-comment">/* HOISTED */</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">_hoisted_20</span> = <span class="hljs-comment">/*#__PURE__*/</span><span class="hljs-title function_ invoke__">_createElementVNode</span>(<span class="hljs-string">"p"</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, -<span class="hljs-number">1</span> <span class="hljs-comment">/* HOISTED */</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="4"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">_hoisted_21</span> = [</span>
<span class="code-block-extension-codeLine" data-line-num="5">  _hoisted_1,</span>
<span class="code-block-extension-codeLine" data-line-num="6">  <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">  _hoisted_20,</span>
<span class="code-block-extension-codeLine" data-line-num="8">]</span>
<span class="code-block-extension-codeLine" data-line-num="9"></span>
<span class="code-block-extension-codeLine" data-line-num="10">export <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">_ctx, _cache, <span class="hljs-variable">$props</span>, <span class="hljs-variable">$setup</span>, <span class="hljs-variable">$data</span>, <span class="hljs-variable">$options</span></span>) </span>{</span>
<span class="code-block-extension-codeLine" data-line-num="11">  <span class="hljs-keyword">return</span> (<span class="hljs-title function_ invoke__">_openBlock</span>(), <span class="hljs-title function_ invoke__">_createElementBlock</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, _hoisted_21))</span>
<span class="code-block-extension-codeLine" data-line-num="12">}</span>
</code></pre>
<p><code>createElementVNode</code> 大量连续性创建 <code>vnode</code> 也是挺影响性能的，所以可以通过 <code>预字符串化</code> 来一次性创建这些静态节点，采用 <code>与字符串化</code> 后，生成的渲染函数如下：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">const</span> _hoisted_1 = <span class="hljs-comment">/*#__PURE__*/</span><span class="hljs-title function_">_createStaticVNode</span>(<span class="hljs-string">"&lt;p&gt;&lt;/p&gt;...&lt;p&gt;&lt;/p&gt;"</span>, <span class="hljs-number">20</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">const</span> _hoisted_21 = [</span>
<span class="code-block-extension-codeLine" data-line-num="3">  _hoisted_1</span>
<span class="code-block-extension-codeLine" data-line-num="4">]</span>
<span class="code-block-extension-codeLine" data-line-num="5"></span>
<span class="code-block-extension-codeLine" data-line-num="6"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx, _cache, $props, $setup, $data, $options</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="7">  <span class="hljs-keyword">return</span> (<span class="hljs-title function_">_openBlock</span>(), <span class="hljs-title function_">_createElementBlock</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, _hoisted_21))</span>
<span class="code-block-extension-codeLine" data-line-num="8">}</span>
</code></pre>
<p>这样一方面降低了 <code>createElementVNode</code> 连续创建带来的性能损耗，也降侧面减少了代码体积。关于 <strong>预字符串化</strong> 实现的细节函数 <code>transformHoist</code> 有兴趣的小伙伴可以再去深入了解。</p>
<h2 data-id="heading-7">4. 创建根代码生成节点</h2>
<p>介绍完了静态提升后，我们还剩最后一个 <code>createRootCodegen</code> 创建根代码生成节点，接下来一起看一下 <code>createRootCodegen</code> 函数的实现：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createRootCodegen</span>(<span class="hljs-params">root, context</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-keyword">const</span> { helper } = context</span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-keyword">const</span> { children } = root</span>
<span class="code-block-extension-codeLine" data-line-num="4">  <span class="hljs-keyword">if</span> (children.<span class="hljs-property">length</span> === <span class="hljs-number">1</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-keyword">const</span> child = children[<span class="hljs-number">0</span>]</span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="hljs-comment">// 如果子节点是单个元素节点，则将其转换成一个 block</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSingleElementRoot</span>(root, child) &amp;&amp; child.<span class="hljs-property">codegenNode</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">      <span class="hljs-keyword">const</span> codegenNode = child.<span class="hljs-property">codegenNode</span></span>
<span class="code-block-extension-codeLine" data-line-num="9">      <span class="hljs-keyword">if</span> (codegenNode.<span class="hljs-property">type</span> === <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">VNODE_CALL</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="10">        <span class="hljs-title function_">makeBlock</span>(codegenNode, context)</span>
<span class="code-block-extension-codeLine" data-line-num="11">      }</span>
<span class="code-block-extension-codeLine" data-line-num="12">      root.<span class="hljs-property">codegenNode</span> = codegenNode</span>
<span class="code-block-extension-codeLine" data-line-num="13">    } <span class="hljs-keyword">else</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="14">      root.<span class="hljs-property">codegenNode</span> = child</span>
<span class="code-block-extension-codeLine" data-line-num="15">    }</span>
<span class="code-block-extension-codeLine" data-line-num="16">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (children.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="17">    <span class="hljs-comment">// 如果子节点是多个节点，则返回一个 fragement 的代码生成节点</span></span>
<span class="code-block-extension-codeLine" data-line-num="18">    <span class="hljs-keyword">let</span> patchFlag = <span class="hljs-title class_">PatchFlags</span>.<span class="hljs-property">STABLE_FRAGMENT</span></span>
<span class="code-block-extension-codeLine" data-line-num="19">    <span class="hljs-keyword">let</span> patchFlagText = <span class="hljs-title class_">PatchFlagNames</span>[<span class="hljs-title class_">PatchFlags</span>.<span class="hljs-property">STABLE_FRAGMENT</span>]</span>
<span class="code-block-extension-codeLine" data-line-num="20">    </span>
<span class="code-block-extension-codeLine" data-line-num="21">    root.<span class="hljs-property">codegenNode</span> = <span class="hljs-title function_">createVNodeCall</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="22">      context,</span>
<span class="code-block-extension-codeLine" data-line-num="23">      <span class="hljs-title function_">helper</span>(<span class="hljs-variable constant_">FRAGMENT</span>),</span>
<span class="code-block-extension-codeLine" data-line-num="24">      <span class="hljs-literal">undefined</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="25">      root.<span class="hljs-property">children</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="26">      patchFlag + (__DEV__ ? <span class="hljs-string">` /* <span class="hljs-subst">${patchFlagText}</span> */`</span> : <span class="hljs-string">``</span>),</span>
<span class="code-block-extension-codeLine" data-line-num="27">      <span class="hljs-literal">undefined</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="28">      <span class="hljs-literal">undefined</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="29">      <span class="hljs-literal">true</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="30">      <span class="hljs-literal">undefined</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="31">      <span class="hljs-literal">false</span> <span class="hljs-comment">/* isComponent */</span></span>
<span class="code-block-extension-codeLine" data-line-num="32">    )</span>
<span class="code-block-extension-codeLine" data-line-num="33">  } <span class="hljs-keyword">else</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="34">    <span class="hljs-comment">// no children = noop. codegen will return null.</span></span>
<span class="code-block-extension-codeLine" data-line-num="35">  }</span>
<span class="code-block-extension-codeLine" data-line-num="36">}</span>
</code></pre>
<p>我们知道，<code>Vue3</code> 中是可以在 <code>template</code> 中写多个字节点的：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">html</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-html code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="4"><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<p><code>createRootCodegen</code>，核心就是创建根节点的 <code>codegenNode</code> 对象。所以当有多个子节点时，也就是 <code>children.length &gt; 1</code> 时，调用 <code>createVNodeCall</code> 来创建一个新的 <code>fragement</code> 根节点 <code>codegenNode</code>。</p>
<p>否则，就代表着只有一个根节点，直接让根节点的 <code>codegenNode</code> 等于第一个子节点的根节点的<code>codegenNode</code>即可。</p>
<p><code>createRootCodegen</code> 完成之后，接着把 <code>transform</code> 上下文在转换 <code>AST</code> 节点过程中创建的一些变量赋值给 <code>root</code> 节点对应的属性，这样方便在后续代码生成的过程中访问到这些变量。</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">root.<span class="hljs-property">helpers</span> = [...context.<span class="hljs-property">helpers</span>.<span class="hljs-title function_">keys</span>()]</span>
<span class="code-block-extension-codeLine" data-line-num="2">root.<span class="hljs-property">components</span> = [...context.<span class="hljs-property">components</span>]</span>
<span class="code-block-extension-codeLine" data-line-num="3">root.<span class="hljs-property">directives</span> = [...context.<span class="hljs-property">directives</span>]</span>
<span class="code-block-extension-codeLine" data-line-num="4">root.<span class="hljs-property">imports</span> = context.<span class="hljs-property">imports</span></span>
<span class="code-block-extension-codeLine" data-line-num="5">root.<span class="hljs-property">hoists</span> = context.<span class="hljs-property">hoists</span></span>
<span class="code-block-extension-codeLine" data-line-num="6">root.<span class="hljs-property">temps</span> = context.<span class="hljs-property">temps</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">root.<span class="hljs-property">cached</span> = context.<span class="hljs-property">cached</span></span>
</code></pre>
<h2 data-id="heading-8">总结</h2>
<p>这里我们介绍了关于 <code>transform</code> 相关的知识，再来回顾一下，<code>transform</code> 节点的核心功能就是语法分析阶段，把 <code>AST</code> 节点做进一层转换，构造出语义化更强，信息更加丰富的 <code>codegenCode</code>。便于在下一小节 <code>generate</code> 中使用。</p></div>
    </body>
    </html>