<!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title></title>
    </head>
    <body>
    <div class="markdown-body"><div style="height:0;font-size:0;"><svg width="0" height="0" viewBox="0 0 171 48" xmlns="http://www.w3.org/2000/svg">
  <clipPath id="jcode-logo-clip">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M29.6735 30.7507L4.24023 7.29975L10.1773 0.857178L29.6735 18.8468L49.2491 0.857178L55.1762 7.29975L29.6735 30.7507ZM59.4204 47.1347H0V23.8225H8.7619V38.3827H50.6684V23.8225H59.4204V47.1347ZM166.243 18.8667C165.88 18.6445 165.49 18.3891 165.067 18.1129C164.925 18.0195 164.778 17.9237 164.628 17.826C164.043 17.4295 163.438 17.0132 162.814 16.5672C162.189 16.1212 161.585 15.6553 160.98 15.1697C160.376 14.684 159.801 14.1983 159.266 13.7127C158.205 14.7038 157.055 15.6553 155.806 16.5573C154.557 17.4593 153.378 18.2324 152.268 18.8766H147.609C148.402 18.4603 149.225 17.9648 150.087 17.3998C150.95 16.8348 151.782 16.2699 152.565 15.6851C153.358 15.1102 154.062 14.5551 154.696 14.0397C155.331 13.5243 155.806 13.0882 156.143 12.7512H162.259C162.626 13.0882 163.141 13.5144 163.805 14.0397C164.469 14.5651 165.193 15.1102 165.996 15.6752C166.788 16.25 167.611 16.815 168.464 17.3899C169.316 17.9648 170.109 18.4603 170.842 18.8766H166.233L166.243 18.8667ZM151.971 33.1692C151.852 32.8124 151.713 32.416 151.554 31.9699C151.439 31.6447 151.318 31.3195 151.195 30.9905C151.15 30.8682 151.104 30.7455 151.059 30.6219C150.89 30.166 150.722 29.7299 150.553 29.3136C150.517 29.2238 150.481 29.1358 150.447 29.0498C150.321 28.7375 150.206 28.4522 150.097 28.2035H153.071C153.102 28.2757 153.135 28.3515 153.17 28.4306L153.17 28.4317C153.278 28.678 153.399 28.9569 153.527 29.264C153.643 29.5444 153.759 29.8294 153.879 30.1224C153.932 30.2542 153.987 30.3876 154.042 30.5228C154.22 30.9589 154.389 31.405 154.557 31.8708C154.726 32.3367 154.875 32.7629 155.013 33.1692H157.729V27.1033H149.393V24.8633H157.729V22.0979H148.789V19.7786H169.633V22.0979H160.723V24.8633H169.028V27.1033H160.723V33.1692H163.518C163.706 32.8025 163.884 32.3961 164.073 31.9501C164.261 31.5041 164.429 31.0581 164.598 30.6021C164.766 30.1462 164.925 29.7101 165.064 29.2938C165.203 28.8775 165.322 28.5108 165.401 28.2134H168.345C168.077 29.0559 167.78 29.9182 167.453 30.8202C167.125 31.7221 166.818 32.5052 166.531 33.1692H170.456V35.5877H147.946V33.1692H151.951H151.971ZM125.131 12.7712V16.5773H122.841V18.966H125.131V24.7544L122.742 25.359V27.9063L125.131 27.3017V29.3931C125.131 30.0473 125.101 30.6519 125.042 31.2168C124.982 31.7818 124.893 32.3071 124.754 32.8027C124.615 33.2983 124.447 33.774 124.249 34.23C124.051 34.6859 123.803 35.1319 123.495 35.5879H126.618C127.004 34.8049 127.282 33.9029 127.47 32.8721C127.658 31.8413 127.748 30.6816 127.748 29.3931V26.6277L129.809 26.0727V23.5254L127.748 24.0804V18.966H129.839V16.5773H127.748V12.7712H125.131ZM129.879 33.5956C129.7 34.339 129.482 35.0031 129.234 35.5879H129.244H132.01C132.416 34.3588 132.703 32.9216 132.882 31.2565C133.06 29.5913 133.149 27.8568 133.149 26.0429V19.9275H145.004V13.1776H130.681V26.0231C130.681 26.9152 130.652 27.7973 130.592 28.6794C130.533 29.5616 130.444 30.414 130.325 31.2466C130.206 32.0692 130.057 32.8622 129.879 33.5956ZM142.456 17.8658H133.239V15.269H142.456V17.8658ZM138.601 33.4271H136.381V28.6993H134.269V35.5978H145.143V28.6993H143.002V33.4271H140.732V27.49H144.855V21.4241H142.793V25.4284H140.732V20.9186H138.591V25.4284H136.529V21.4241H134.468V27.49H138.601V33.4271ZM106.326 32.9906V12.7808H109.25V19.2233H119.519V21.8202H109.25V33.0005H120.302V35.5478H97.4453V33.0005H106.326V32.9906ZM72.3125 24.9129C72.7486 23.5748 73.1352 22.1971 73.4623 20.7797C73.7893 19.3722 74.0669 17.9251 74.3047 16.4483H72.4116V14.129H81.2033V16.4483H76.743C76.6538 17.0826 76.5646 17.717 76.4655 18.3513C76.3664 18.9857 76.2474 19.6101 76.1087 20.2544H81.0645V34.656H73.8686V24.9129H72.3125ZM76.188 32.416H78.7848V22.5241H76.188V32.416ZM89.6083 35.5877L89.6171 35.5778H92.9783C93.3351 34.8939 93.6226 34.0316 93.8604 33.0008C94.0983 31.97 94.2173 30.8499 94.2173 29.6407V22.99H92.7107L93.3153 13.3459H82.1845V15.7347H90.5896L90.0345 22.99H85.4554L85.7527 17.0727H83.1856L82.8089 25.3589H91.6204V29.5416C91.6204 30.8202 91.4321 31.9799 91.0455 33.0404C90.661 34.0954 90.1784 34.9445 89.6171 35.5778H89.6083V35.5877ZM90.5103 28.3621V30.7013H82.2043V28.3621H90.5103Z"></path>
  </clipPath>
</svg></div><style>.auditing-placeholder {
  width: 100%;
  height: 100%;
}
.auditing-placeholder, .loading-placeholder {
  pointer-events: none;
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1;
  box-sizing: border-box;
  overflow: hidden;
  border: 0.5px solid rgba(128,128,128,0.4);
  border-radius: 8px;
  background-color: #18212D;
}
.placeholder-image {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
}
.loading-logo {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  z-index: 1;
  width: 171px;
  height: 48px;
  background-image: repeating-linear-gradient(
    94.31deg,
    #00cdff 2.29%,
    #ffffff 19.72%,
    #7d5aff 50%,
    #ffffff 85.28%,
    #00cdff 97.72%
  );
  background-size: 200%;
  background-repeat: repeat;
  clip-path: url(#jcode-logo-clip);
  animation: logo-scan 3s linear infinite;
}
@keyframes logo-scan {
  0% {
    background-position-x: 200%;
  }

  100% {
    background-position-x: 0%;
  }
}</style><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre>code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p><code>Vue</code> 内置了 <code>Trasition</code> 组件可以帮助我们快速简单的实现基于状态变换的动画效果。该组件支持了 <code>CSS 过渡动画</code>、<code>CSS 动画</code>、<code>Javascript 钩子</code> 几种模式，接下来我们将逐步介绍这几种模式的实现原理。</p>
<h2 data-id="heading-1">基于 CSS 的过渡效果</h2>
<p>我们先来看官网上一个简单的关于 <code>CSS Transiton</code> 过渡动画的示例：
以下是最基本用法的示例：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">html</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-html code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"show = !show"</span>&gt;</span>Toggle<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-tag">&lt;<span class="hljs-name">Transition</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"show"</span>&gt;</span>hello<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="5">  <span class="hljs-tag">&lt;/<span class="hljs-name">Transition</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="6"><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="7"></span>
<span class="code-block-extension-codeLine" data-line-num="8"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"></span></span>
<span class="code-block-extension-codeLine" data-line-num="9">  <span class="hljs-selector-class">.v-enter-active</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="10">  <span class="hljs-selector-class">.v-leave-active</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="11">    <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.5s</span> ease;</span>
<span class="code-block-extension-codeLine" data-line-num="12">  }</span>
<span class="code-block-extension-codeLine" data-line-num="13"></span>
<span class="code-block-extension-codeLine" data-line-num="14">  <span class="hljs-selector-class">.v-enter-from</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="15">  <span class="hljs-selector-class">.v-leave-to</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="16">    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="17">  }</span>
<span class="code-block-extension-codeLine" data-line-num="18"><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<p>然后再来看看官网上对于这些类名的实现定义：</p>
<ol>
<li><code>v-enter-from</code>：进入动画的起始状态。在元素插入之前添加，在元素插入完成后的下一帧移除。</li>
<li><code>v-enter-active</code>：进入动画的生效状态。应用于整个进入动画阶段。在元素被插入之前添加，在过渡或动画完成之后移除。这个 <code>class</code> 可以被用来定义进入动画的持续时间、延迟与速度曲线类型。</li>
<li><code>v-enter-to</code>：进入动画的结束状态。在元素插入完成后的下一帧被添加 (也就是&nbsp;<code>v-enter-from</code>&nbsp;被移除的同时)，在过渡或动画完成之后移除。</li>
<li><code>v-leave-from</code>：离开动画的起始状态。在离开过渡效果被触发时立即添加，在一帧后被移除。</li>
<li><code>v-leave-active</code>：离开动画的生效状态。应用于整个离开动画阶段。在离开过渡效果被触发时立即添加，在过渡或动画完成之后移除。这个 class 可以被用来定义离开动画的持续时间、延迟与速度曲线类型。</li>
<li><code>v-leave-to</code>：离开动画的结束状态。在一个离开动画被触发后的下一帧被添加 (也就是&nbsp;<code>v-leave-from</code>&nbsp;被移除的同时)，在过渡或动画完成之后移除。</li>
</ol>
<p>抛开源码不谈，如果在一个普通的 <code>Vue</code> 组件中，我们如何实现一个上述功能的过渡状态的 <code>CSS</code> 动画效果呢？按照官网上的定义，我们一起来尝试一下：</p>
<p><span href="https://code.juejin.cn/pen/7167177061931417630" target="_blank" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7167177061931417630" data-src="https://code.juejin.cn/pen/7167177061931417630" style="display: block;" loading="lazy" src="https://code.juejin.cn/pen/7167177061931417630"></iframe><span class="loading-placeholder" style="display: none;"><img class="placeholder-image" src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/img/loading-placeholder.9112506.png" loading="lazy"><span class="loading-logo"></span></span></span></p>
<p>可以看到，我们参考官网的描述，也可以简单的实现一个基于 <code>css</code> 的过渡动画，但这里存在了几个问题：</p>
<ol>
<li>硬编码了 <code>transiton</code> 动画，没有实现 <code>animate</code> 动画。</li>
<li>不够抽象，难以复用到后续组件。</li>
</ol>
<p>接下来我们一起来看看 <code>Vue</code> 源码是如何实现的，首先找到关于 <code>Transition</code> 组件的定义：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">Transition</span> = (<span class="hljs-params">props, { slots }</span>) =&gt; <span class="hljs-title function_">h</span>(<span class="hljs-title class_">BaseTransition</span>, <span class="hljs-title function_">resolveTransitionProps</span>(props), slots)</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-title class_">Transition</span>.<span class="hljs-property">displayName</span> = <span class="hljs-string">'Transition'</span></span>
</code></pre>
<p>代码很简单，<code>Transition</code> 组件是一个函数式组件，本身就是一个渲染函数。还记得我们之前说过吗，<code>Vue</code> 组件分为了有状态组件和函数组件，有状态组件内部会存储组件的状态，而函数组件不会。</p>
<p>我们知道 <code>Vue</code> 对 <code>Transtion</code> 内置组件的功能定义就是只是一个<strong>容器</strong>，一个搬运工，需要渲染 <code>DOM</code>，那就不需要 <code>template</code>，本身不需要维护任何状态。所以这里直接通过一个函数式组件定义了 <code>Transition</code> 组件。</p>
<p>接着，我们看到了该组件核心功能就是一个渲染 <code>BaseTransition</code> 组件，并为期传入<strong>处理好的 <code>props</code></strong> 和内部挂载的 <code>slot</code>。先来看看 <code>BaseTransition</code> 组件，这里我们只关心与 <code>CSS</code> 动画相关的逻辑。</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">const</span> <span class="hljs-title class_">BaseTransitionImpl</span> = {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-attr">name</span>: <span class="hljs-string">`BaseTransition`</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">  <span class="hljs-attr">props</span>: {</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="6">  },</span>
<span class="code-block-extension-codeLine" data-line-num="7"></span>
<span class="code-block-extension-codeLine" data-line-num="8">  <span class="hljs-title function_">setup</span>(<span class="hljs-params">props, { slots }</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="9">    <span class="hljs-comment">// 当前渲染的组价实例</span></span>
<span class="code-block-extension-codeLine" data-line-num="10">    <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">getCurrentInstance</span>()!</span>
<span class="code-block-extension-codeLine" data-line-num="11">    <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">useTransitionState</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="12">    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="13">      <span class="hljs-comment">/**</span></span>
<span class="code-block-extension-codeLine" data-line-num="14">       * 这里都是进入状态需要定义的内容</span>
<span class="code-block-extension-codeLine" data-line-num="15">       */</span>
<span class="code-block-extension-codeLine" data-line-num="16">      <span class="hljs-comment">// 获取子节点</span></span>
<span class="code-block-extension-codeLine" data-line-num="17">      <span class="hljs-keyword">const</span> children =</span>
<span class="code-block-extension-codeLine" data-line-num="18">        slots.<span class="hljs-property">default</span> &amp;&amp; <span class="hljs-title function_">getTransitionRawChildren</span>(slots.<span class="hljs-title function_">default</span>(), <span class="hljs-literal">true</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="19">      <span class="hljs-keyword">if</span> (!children || !children.<span class="hljs-property">length</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="20">        <span class="hljs-keyword">return</span></span>
<span class="code-block-extension-codeLine" data-line-num="21">      }</span>
<span class="code-block-extension-codeLine" data-line-num="22"></span>
<span class="code-block-extension-codeLine" data-line-num="23">      <span class="hljs-keyword">let</span> child = children[<span class="hljs-number">0</span>]</span>
<span class="code-block-extension-codeLine" data-line-num="24">      </span>
<span class="code-block-extension-codeLine" data-line-num="25">      <span class="hljs-comment">// 这里 props 不需要响应式追踪，为了更好的性能，去除响应式</span></span>
<span class="code-block-extension-codeLine" data-line-num="26">      <span class="hljs-keyword">const</span> rawProps = <span class="hljs-title function_">toRaw</span>(props)</span>
<span class="code-block-extension-codeLine" data-line-num="27">      <span class="hljs-keyword">const</span> { mode } = rawProps</span>
<span class="code-block-extension-codeLine" data-line-num="28">      </span>
<span class="code-block-extension-codeLine" data-line-num="29">      <span class="hljs-comment">// 获取当前的容器节点</span></span>
<span class="code-block-extension-codeLine" data-line-num="30">      <span class="hljs-keyword">const</span> innerChild = <span class="hljs-title function_">getKeepAliveChild</span>(child)</span>
<span class="code-block-extension-codeLine" data-line-num="31">      <span class="hljs-keyword">if</span> (!innerChild) {</span>
<span class="code-block-extension-codeLine" data-line-num="32">        <span class="hljs-keyword">return</span> <span class="hljs-title function_">emptyPlaceholder</span>(child)</span>
<span class="code-block-extension-codeLine" data-line-num="33">      }</span>
<span class="code-block-extension-codeLine" data-line-num="34"></span>
<span class="code-block-extension-codeLine" data-line-num="35">      <span class="hljs-comment">// 获取进入状态的调用函数</span></span>
<span class="code-block-extension-codeLine" data-line-num="36">      <span class="hljs-keyword">const</span> enterHooks = <span class="hljs-title function_">resolveTransitionHooks</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="37">        innerChild,</span>
<span class="code-block-extension-codeLine" data-line-num="38">        rawProps,</span>
<span class="code-block-extension-codeLine" data-line-num="39">        state,</span>
<span class="code-block-extension-codeLine" data-line-num="40">        instance</span>
<span class="code-block-extension-codeLine" data-line-num="41">      )</span>
<span class="code-block-extension-codeLine" data-line-num="42">      </span>
<span class="code-block-extension-codeLine" data-line-num="43">      <span class="hljs-comment">// 为子节点添加进入 hooks 属性</span></span>
<span class="code-block-extension-codeLine" data-line-num="44">      <span class="hljs-title function_">setTransitionHooks</span>(innerChild, enterHooks)</span>
<span class="code-block-extension-codeLine" data-line-num="45">  </span>
<span class="code-block-extension-codeLine" data-line-num="46">      <span class="hljs-comment">/**</span></span>
<span class="code-block-extension-codeLine" data-line-num="47">       * 下面都是离开状态需要定义的内容</span>
<span class="code-block-extension-codeLine" data-line-num="48">       */</span>
<span class="code-block-extension-codeLine" data-line-num="49">      <span class="hljs-comment">// 离开状态中，之前的节点就是旧节点了</span></span>
<span class="code-block-extension-codeLine" data-line-num="50">      <span class="hljs-keyword">const</span> oldChild = instance.<span class="hljs-property">subTree</span></span>
<span class="code-block-extension-codeLine" data-line-num="51">      <span class="hljs-keyword">const</span> oldInnerChild = oldChild &amp;&amp; <span class="hljs-title function_">getKeepAliveChild</span>(oldChild)</span>
<span class="code-block-extension-codeLine" data-line-num="52"></span>
<span class="code-block-extension-codeLine" data-line-num="53">      <span class="hljs-keyword">let</span> transitionKeyChanged = <span class="hljs-literal">false</span></span>
<span class="code-block-extension-codeLine" data-line-num="54">     </span>
<span class="code-block-extension-codeLine" data-line-num="55">      <span class="hljs-keyword">if</span> (</span>
<span class="code-block-extension-codeLine" data-line-num="56">        oldInnerChild &amp;&amp;</span>
<span class="code-block-extension-codeLine" data-line-num="57">        oldInnerChild.<span class="hljs-property">type</span> !== <span class="hljs-title class_">Comment</span> &amp;&amp;</span>
<span class="code-block-extension-codeLine" data-line-num="58">        (!<span class="hljs-title function_">isSameVNodeType</span>(innerChild, oldInnerChild) || transitionKeyChanged)</span>
<span class="code-block-extension-codeLine" data-line-num="59">      ) {</span>
<span class="code-block-extension-codeLine" data-line-num="60">        <span class="hljs-comment">// 获取离开状态的调用函数</span></span>
<span class="code-block-extension-codeLine" data-line-num="61">        <span class="hljs-keyword">const</span> leavingHooks = <span class="hljs-title function_">resolveTransitionHooks</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="62">          oldInnerChild,</span>
<span class="code-block-extension-codeLine" data-line-num="63">          rawProps,</span>
<span class="code-block-extension-codeLine" data-line-num="64">          state,</span>
<span class="code-block-extension-codeLine" data-line-num="65">          instance</span>
<span class="code-block-extension-codeLine" data-line-num="66">        )</span>
<span class="code-block-extension-codeLine" data-line-num="67">        <span class="hljs-comment">// 为子节点添加离开 hooks 属性</span></span>
<span class="code-block-extension-codeLine" data-line-num="68">        <span class="hljs-title function_">setTransitionHooks</span>(oldInnerChild, leavingHooks)</span>
<span class="code-block-extension-codeLine" data-line-num="69">        <span class="hljs-comment">// out-in 模式状态切换</span></span>
<span class="code-block-extension-codeLine" data-line-num="70">        <span class="hljs-keyword">if</span> (mode === <span class="hljs-string">'out-in'</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="71">          state.<span class="hljs-property">isLeaving</span> = <span class="hljs-literal">true</span></span>
<span class="code-block-extension-codeLine" data-line-num="72">          <span class="hljs-comment">// 返回空的占位符节点，当离开过渡结束后，重新渲染组件</span></span>
<span class="code-block-extension-codeLine" data-line-num="73">          leavingHooks.<span class="hljs-property">afterLeave</span> = <span class="hljs-function">() =&gt;</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="74">            state.<span class="hljs-property">isLeaving</span> = <span class="hljs-literal">false</span></span>
<span class="code-block-extension-codeLine" data-line-num="75">            <span class="hljs-comment">// 当 active = false 时，被卸载状态不需要更新</span></span>
<span class="code-block-extension-codeLine" data-line-num="76">            <span class="hljs-keyword">if</span> (instance.<span class="hljs-property">update</span>.<span class="hljs-property">active</span> !== <span class="hljs-literal">false</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="77">              instance.<span class="hljs-title function_">update</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="78">            }</span>
<span class="code-block-extension-codeLine" data-line-num="79">            instance.<span class="hljs-title function_">update</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="80">          }</span>
<span class="code-block-extension-codeLine" data-line-num="81">          <span class="hljs-keyword">return</span> <span class="hljs-title function_">emptyPlaceholder</span>(child)</span>
<span class="code-block-extension-codeLine" data-line-num="82">        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mode === <span class="hljs-string">'in-out'</span> &amp;&amp; innerChild.<span class="hljs-property">type</span> !== <span class="hljs-title class_">Comment</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="83">          <span class="hljs-comment">// in-out 模式状态切换，延迟移除</span></span>
<span class="code-block-extension-codeLine" data-line-num="84">          leavingHooks.<span class="hljs-property">delayLeave</span> = <span class="hljs-function">(<span class="hljs-params">el, earlyRemove, delayedLeave</span>) =&gt;</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="85">            <span class="hljs-comment">// 先缓存需要移除的节点</span></span>
<span class="code-block-extension-codeLine" data-line-num="86">            <span class="hljs-keyword">const</span> leavingVNodesCache = <span class="hljs-title function_">getLeavingNodesForType</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="87">              state,</span>
<span class="code-block-extension-codeLine" data-line-num="88">              oldInnerChild</span>
<span class="code-block-extension-codeLine" data-line-num="89">            )</span>
<span class="code-block-extension-codeLine" data-line-num="90">            leavingVNodesCache[<span class="hljs-title class_">String</span>(oldInnerChild.<span class="hljs-property">key</span>)] = oldInnerChild</span>
<span class="code-block-extension-codeLine" data-line-num="91">            el.<span class="hljs-property">_leaveCb</span> = <span class="hljs-function">() =&gt;</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="92">              <span class="hljs-title function_">earlyRemove</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="93">              el.<span class="hljs-property">_leaveCb</span> = <span class="hljs-literal">undefined</span></span>
<span class="code-block-extension-codeLine" data-line-num="94">              <span class="hljs-keyword">delete</span> enterHooks.<span class="hljs-property">delayedLeave</span></span>
<span class="code-block-extension-codeLine" data-line-num="95">            }</span>
<span class="code-block-extension-codeLine" data-line-num="96">            enterHooks.<span class="hljs-property">delayedLeave</span> = delayedLeave</span>
<span class="code-block-extension-codeLine" data-line-num="97">          }</span>
<span class="code-block-extension-codeLine" data-line-num="98">        }</span>
<span class="code-block-extension-codeLine" data-line-num="99">      }</span>
<span class="code-block-extension-codeLine" data-line-num="100">      <span class="hljs-comment">// 返回子节点</span></span>
<span class="code-block-extension-codeLine" data-line-num="101">      <span class="hljs-keyword">return</span> child</span>
<span class="code-block-extension-codeLine" data-line-num="102">    }</span>
<span class="code-block-extension-codeLine" data-line-num="103">  }</span>
<span class="code-block-extension-codeLine" data-line-num="104">}</span>
</code></pre>
<p>可以看到 <code>BaseTransitionImpl</code> 的 <code>setup</code> 函数，核心就干了三件事儿：</p>
<p><strong>Step 1:</strong> 为 <code>Transition</code> 下的子节点添加 <code>enterHooks</code>。</p>
<p><strong>Step 2:</strong> 为 <code>Transition</code> 下的子节点添加 <code>leavingHooks</code>。</p>
<p><strong>Step 3:</strong> 处理完成后直接返回子节点作为渲染内容。</p>
<p>那么，这些 <code>hooks</code> 到底做了些什么？以及这些 <code>hooks</code> 是在什么时候被执行的呢？我们一个个来看。</p>
<h3 data-id="heading-2">1. <code>hooks</code> 到底做了些什么？</h3>
<p>要回答这些 <code>hooks</code> 到底做了什么？首先需要了解这些 <code>hooks</code> 是从哪里来的。再回到上述源码，我们知道 <code>hooks</code> 是通过：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">const</span> leavingHooks = <span class="hljs-title function_">resolveTransitionHooks</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="2">  oldInnerChild,</span>
<span class="code-block-extension-codeLine" data-line-num="3">  rawProps,</span>
<span class="code-block-extension-codeLine" data-line-num="4">  state,</span>
<span class="code-block-extension-codeLine" data-line-num="5">  instance</span>
<span class="code-block-extension-codeLine" data-line-num="6">)</span>
</code></pre>
<p>这样的函数调用产生的，现在我们先不讨论这个函数的具体实现，先看看该函数的入参，有一个 <code>rawProps</code> 的参数，这个就是上文所说的 <code>Transition</code> 组件 <code>render</code> 函数中传入的 <code>props</code> 参数。</p>
<p>接下来就需要分析 <code>props</code> 中有些什么东西：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">function</span> <span class="hljs-title function_">resolveTransitionProps</span>(<span class="hljs-params">rawProps</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-keyword">const</span> baseProps = {}</span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> rawProps) {</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-keyword">if</span> (!(key <span class="hljs-keyword">in</span> <span class="hljs-title class_">DOMTransitionPropsValidators</span>)) {</span>
<span class="code-block-extension-codeLine" data-line-num="6">      baseProps[key] = rawProps[key]</span>
<span class="code-block-extension-codeLine" data-line-num="7">    }</span>
<span class="code-block-extension-codeLine" data-line-num="8">  }</span>
<span class="code-block-extension-codeLine" data-line-num="9">  <span class="hljs-keyword">const</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="10">    name = <span class="hljs-string">'v'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="11">    type,</span>
<span class="code-block-extension-codeLine" data-line-num="12">    duration,</span>
<span class="code-block-extension-codeLine" data-line-num="13">    enterFromClass = <span class="hljs-string">`<span class="hljs-subst">${name}</span>-enter-from`</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="14">    enterActiveClass = <span class="hljs-string">`<span class="hljs-subst">${name}</span>-enter-active`</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="15">    enterToClass = <span class="hljs-string">`<span class="hljs-subst">${name}</span>-enter-to`</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="16">    appearFromClass = enterFromClass,</span>
<span class="code-block-extension-codeLine" data-line-num="17">    appearActiveClass = enterActiveClass,</span>
<span class="code-block-extension-codeLine" data-line-num="18">    appearToClass = enterToClass,</span>
<span class="code-block-extension-codeLine" data-line-num="19">    leaveFromClass = <span class="hljs-string">`<span class="hljs-subst">${name}</span>-leave-from`</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="20">    leaveActiveClass = <span class="hljs-string">`<span class="hljs-subst">${name}</span>-leave-active`</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="21">    leaveToClass = <span class="hljs-string">`<span class="hljs-subst">${name}</span>-leave-to`</span></span>
<span class="code-block-extension-codeLine" data-line-num="22">  } = rawProps</span>
<span class="code-block-extension-codeLine" data-line-num="23">  <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="24">  <span class="hljs-keyword">return</span> <span class="hljs-title function_">extend</span>(baseProps, {</span>
<span class="code-block-extension-codeLine" data-line-num="25">    <span class="hljs-attr">onEnter</span>: <span class="hljs-title function_">makeEnterHook</span>(<span class="hljs-literal">false</span>),</span>
<span class="code-block-extension-codeLine" data-line-num="26">    <span class="hljs-attr">onLeave</span>: <span class="hljs-function">() =&gt;</span> {},</span>
<span class="code-block-extension-codeLine" data-line-num="27">    <span class="hljs-comment">// ....</span></span>
<span class="code-block-extension-codeLine" data-line-num="28">  })</span>
<span class="code-block-extension-codeLine" data-line-num="29">}</span>
</code></pre>
<p>根据我们前面了解到的，<code>Vue</code> 会在特定阶段为节点增加或删除特定 <code>class</code>。而这个 <code>props</code> 正式为了所谓的 <strong>特定的阶段</strong> 量身打造的 <strong>钩子</strong> 函数。举个例子，我们需要实现进入节点的 <code>v-enter-from、v-enter-active、v-enter-to</code> 类名的添加，我们只需要在 <code>onEnter</code> 进入钩子内实现逻辑：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">scss</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-scss code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">const makeEnterHook = (isAppear) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  return (el, done) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="3">    <span class="hljs-comment">// 移除 v-enter-to、v-enter-active 类名</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">    const resolve = () =&gt; <span class="hljs-built_in">finishEnter</span>(el, isAppear, done)</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-comment">// 下一帧渲染时</span></span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="hljs-built_in">nextFrame</span>(() =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="7">      <span class="hljs-comment">// 删除 v-enter-from 类名</span></span>
<span class="code-block-extension-codeLine" data-line-num="8">      <span class="hljs-built_in">removeTransitionClass</span>(el, isAppear ? appearFromClass : enterFromClass)</span>
<span class="code-block-extension-codeLine" data-line-num="9">      <span class="hljs-comment">// 添加 v-enter-to 类名</span></span>
<span class="code-block-extension-codeLine" data-line-num="10">      <span class="hljs-built_in">addTransitionClass</span>(el, isAppear ? appearToClass : enterToClass)</span>
<span class="code-block-extension-codeLine" data-line-num="11">      <span class="hljs-comment">// 动画结束时，执行 resolve 函数，即删除 v-enter-to、v-enter-active 类名</span></span>
<span class="code-block-extension-codeLine" data-line-num="12">      if (!hasExplicitCallback(hook)) {</span>
<span class="code-block-extension-codeLine" data-line-num="13">        <span class="hljs-built_in">whenTransitionEnds</span>(el, type, enterDuration, resolve)</span>
<span class="code-block-extension-codeLine" data-line-num="14">      }</span>
<span class="code-block-extension-codeLine" data-line-num="15">    })</span>
<span class="code-block-extension-codeLine" data-line-num="16">  }</span>
<span class="code-block-extension-codeLine" data-line-num="17">}</span>
</code></pre>
<p>这里的流程是不是跟上面的描述一毛一样！</p>
<h3 data-id="heading-3">2. hooks 何时执行？</h3>
<p>前面我们提到 <code>hooks</code> 将会在特定时间执行，用来对 <code>class</code> 进行增加或删除。比如 <code>enter-from</code> 至 <code>enter-to</code> 阶段的过渡或者动画效果的 <code>class</code> 被添加到<code>DOM</code> 元素上。考虑到 <code>Vue</code> 在 <code>patch</code> 阶段已经有生成对应的 <code>DOM</code> （只不过还没有被真实的挂载到页面上而已）。所以我们只需要在 <code>patch</code> 阶段做对应的 <code>class</code> 增删即可。</p>
<p>比如进入阶段的钩子函数，将会在 <code>mountElement</code> 中被调用：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-comment">// 挂载元素节点</span></span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">const</span> <span class="hljs-title function_">mountElement</span> = (<span class="hljs-params">vnode,...args</span>) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-keyword">let</span> el;</span>
<span class="code-block-extension-codeLine" data-line-num="4">  <span class="hljs-keyword">let</span> vnodeHook;</span>
<span class="code-block-extension-codeLine" data-line-num="5">  <span class="hljs-keyword">const</span> { type, props, shapeFlag, transition, patchFlag, dirs } = vnode;</span>
<span class="code-block-extension-codeLine" data-line-num="6">  <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">  <span class="hljs-keyword">if</span> (needCallTransitionHooks*) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-comment">// 执行 beforeEnter 钩子</span></span>
<span class="code-block-extension-codeLine" data-line-num="9">    transition.<span class="hljs-title function_">beforeEnter</span>(el);</span>
<span class="code-block-extension-codeLine" data-line-num="10">  }</span>
<span class="code-block-extension-codeLine" data-line-num="11">  <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="12">  <span class="hljs-keyword">if</span> ((vnodeHook = props &amp;&amp; props.<span class="hljs-property">onVnodeMounted</span>) || needCallTransitionHooks || dirs) {</span>
<span class="code-block-extension-codeLine" data-line-num="13">      <span class="hljs-comment">// post 各种钩子 至后置执行任务池</span></span>
<span class="code-block-extension-codeLine" data-line-num="14">      <span class="hljs-title function_">queuePostRenderEffect</span>(<span class="hljs-function">() =&gt;</span> { </span>
<span class="code-block-extension-codeLine" data-line-num="15">        <span class="hljs-comment">// 执行 enter 钩子</span></span>
<span class="code-block-extension-codeLine" data-line-num="16">        needCallTransitionHooks &amp;&amp; transition.<span class="hljs-title function_">enter</span>(el); </span>
<span class="code-block-extension-codeLine" data-line-num="17">      }, parentSuspense);</span>
<span class="code-block-extension-codeLine" data-line-num="18">  }</span>
<span class="code-block-extension-codeLine" data-line-num="19">};</span>
</code></pre>
<p>离开阶段的钩子函数，在 <code>remove</code> 节点的时候被调用：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-comment">// 移除 Vnode</span></span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">const</span> <span class="hljs-title function_">remove</span> = vnode =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-keyword">const</span> { type, el, anchor, transition } = vnode;</span>
<span class="code-block-extension-codeLine" data-line-num="4">  <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="5"></span>
<span class="code-block-extension-codeLine" data-line-num="6">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">performRemove</span> = (<span class="hljs-params"></span>) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-title function_">hostRemove</span>(el);</span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-keyword">if</span> (transition &amp;&amp; !transition.<span class="hljs-property">persisted</span> &amp;&amp; transition.<span class="hljs-property">afterLeave</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="9">      <span class="hljs-comment">// 执行 afterLeave 钩子</span></span>
<span class="code-block-extension-codeLine" data-line-num="10">      transition.<span class="hljs-title function_">afterLeave</span>();</span>
<span class="code-block-extension-codeLine" data-line-num="11">    }</span>
<span class="code-block-extension-codeLine" data-line-num="12">  };</span>
<span class="code-block-extension-codeLine" data-line-num="13"></span>
<span class="code-block-extension-codeLine" data-line-num="14">  <span class="hljs-keyword">if</span> (vnode.<span class="hljs-property">shapeFlag</span> &amp; <span class="hljs-number">1</span> <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">ELEMENT</span> &amp;&amp; transition &amp;&amp; !transition.<span class="hljs-property">persisted</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="15">    <span class="hljs-keyword">const</span> { leave, delayLeave } = transition;</span>
<span class="code-block-extension-codeLine" data-line-num="16">    <span class="hljs-comment">// 执行 leave 钩子</span></span>
<span class="code-block-extension-codeLine" data-line-num="17">    <span class="hljs-keyword">const</span> <span class="hljs-title function_">performLeave</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title function_">leave</span>(el, performRemove);</span>
<span class="code-block-extension-codeLine" data-line-num="18">    <span class="hljs-keyword">if</span> (delayLeave) {</span>
<span class="code-block-extension-codeLine" data-line-num="19">       <span class="hljs-comment">// 执行 delayLeave 钩子</span></span>
<span class="code-block-extension-codeLine" data-line-num="20">      <span class="hljs-title function_">delayLeave</span>(vnode.<span class="hljs-property">el</span>, performRemove, performLeave);</span>
<span class="code-block-extension-codeLine" data-line-num="21">    }</span>
<span class="code-block-extension-codeLine" data-line-num="22">    <span class="hljs-keyword">else</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="23">      <span class="hljs-title function_">performLeave</span>();</span>
<span class="code-block-extension-codeLine" data-line-num="24">    }</span>
<span class="code-block-extension-codeLine" data-line-num="25">  }</span>
<span class="code-block-extension-codeLine" data-line-num="26">};</span>
</code></pre>
<p>为了更加清晰的看懂这个流程，我画了个状态流转图，可以简单看一下，方便理解：</p>
<p><img src="p1-juejin.byteimg.comtos-cn-i-k3u1fbpfcpe286d7a4e5294b2c995b164d9dc102e8~tplv-k3u1fbpfcp-jj-mark1512000q75.awebp" alt="image.png" loading="lazy" class="medium-zoom-image"></p>
<h2 data-id="heading-4">JavaScript 钩子</h2>
<p><code>&lt;Transition&gt;</code>&nbsp;组件在动画过渡的各个阶段定义了很多钩子函数，我们可以通过在钩子函数内部自定义实现各种动画效果。</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">html</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-html code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-tag">&lt;<span class="hljs-name">Transition</span></span></span>
<span class="code-block-extension-codeLine" data-line-num="2">  @<span class="hljs-attr">before-enter</span>=<span class="hljs-string">"onBeforeEnter"</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">  @<span class="hljs-attr">enter</span>=<span class="hljs-string">"onEnter"</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">  @<span class="hljs-attr">after-enter</span>=<span class="hljs-string">"onAfterEnter"</span></span>
<span class="code-block-extension-codeLine" data-line-num="5">  @<span class="hljs-attr">enter-cancelled</span>=<span class="hljs-string">"onEnterCancelled"</span></span>
<span class="code-block-extension-codeLine" data-line-num="6">  @<span class="hljs-attr">before-leave</span>=<span class="hljs-string">"onBeforeLeave"</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">  @<span class="hljs-attr">leave</span>=<span class="hljs-string">"onLeave"</span></span>
<span class="code-block-extension-codeLine" data-line-num="8">  @<span class="hljs-attr">after-leave</span>=<span class="hljs-string">"onAfterLeave"</span></span>
<span class="code-block-extension-codeLine" data-line-num="9">  @<span class="hljs-attr">leave-cancelled</span>=<span class="hljs-string">"onLeaveCancelled"</span></span>
<span class="code-block-extension-codeLine" data-line-num="10">&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="11">  <span class="hljs-comment">&lt;!-- ... --&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="12"><span class="hljs-tag">&lt;/<span class="hljs-name">Transition</span>&gt;</span></span>
</code></pre>
<p>前面其实已经稍微提及到了部分钩子函数，比如 <code>onEnter</code>，这些钩子函数在源码中会被合并到 <code>Transiton</code> 下子节点的 <code>transition</code> 属性上。这块的实现主要是通过 <code>setTransitionHooks</code> 函数来实现的：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">const</span> <span class="hljs-title class_">BaseTransitionImpl</span> = {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-attr">name</span>: <span class="hljs-string">`BaseTransition`</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">  <span class="hljs-attr">props</span>: {</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="6">  },</span>
<span class="code-block-extension-codeLine" data-line-num="7"></span>
<span class="code-block-extension-codeLine" data-line-num="8">  <span class="hljs-title function_">setup</span>(<span class="hljs-params">props, { slots }</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="9">    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="10">      <span class="hljs-comment">// 获取进入状态的调用函数</span></span>
<span class="code-block-extension-codeLine" data-line-num="11">      <span class="hljs-keyword">const</span> enterHooks = <span class="hljs-title function_">resolveTransitionHooks</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="12">        innerChild,</span>
<span class="code-block-extension-codeLine" data-line-num="13">        rawProps,</span>
<span class="code-block-extension-codeLine" data-line-num="14">        state,</span>
<span class="code-block-extension-codeLine" data-line-num="15">        instance</span>
<span class="code-block-extension-codeLine" data-line-num="16">      )</span>
<span class="code-block-extension-codeLine" data-line-num="17">      </span>
<span class="code-block-extension-codeLine" data-line-num="18">      <span class="hljs-comment">// 为子节点添加进入 hooks 属性</span></span>
<span class="code-block-extension-codeLine" data-line-num="19">      <span class="hljs-title function_">setTransitionHooks</span>(innerChild, enterHooks)</span>
<span class="code-block-extension-codeLine" data-line-num="20">  </span>
<span class="code-block-extension-codeLine" data-line-num="21">      <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="22">      <span class="hljs-comment">// 返回子节点</span></span>
<span class="code-block-extension-codeLine" data-line-num="23">      <span class="hljs-keyword">return</span> child</span>
<span class="code-block-extension-codeLine" data-line-num="24">    }</span>
<span class="code-block-extension-codeLine" data-line-num="25">  }</span>
<span class="code-block-extension-codeLine" data-line-num="26">}</span>
<span class="code-block-extension-codeLine" data-line-num="27"></span>
<span class="code-block-extension-codeLine" data-line-num="28"><span class="hljs-comment">// 为 vnode 添加 transition 属性</span></span>
<span class="code-block-extension-codeLine" data-line-num="29"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setTransitionHooks</span>(<span class="hljs-params">vnode, hooks</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="30">  <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="31">  vnode.<span class="hljs-property">transition</span> = hooks</span>
<span class="code-block-extension-codeLine" data-line-num="32">}</span>
</code></pre>
<p>其中 <code>hooks</code> 包含了哪些内容呢？<code>hooks</code> 其实是通过 <code>resolveTransitionHooks</code> 函数调用生成的：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">resolveTransitionHooks</span>(<span class="hljs-params">vnode, props, state, instance</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-comment">// 传入的各个钩子函数</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-keyword">const</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="4">    appear,</span>
<span class="code-block-extension-codeLine" data-line-num="5">    mode,</span>
<span class="code-block-extension-codeLine" data-line-num="6">    persisted = <span class="hljs-literal">false</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="7">    onBeforeEnter,</span>
<span class="code-block-extension-codeLine" data-line-num="8">    onEnter,</span>
<span class="code-block-extension-codeLine" data-line-num="9">    onAfterEnter,</span>
<span class="code-block-extension-codeLine" data-line-num="10">    onEnterCancelled,</span>
<span class="code-block-extension-codeLine" data-line-num="11">    onBeforeLeave,</span>
<span class="code-block-extension-codeLine" data-line-num="12">    onLeave,</span>
<span class="code-block-extension-codeLine" data-line-num="13">    onAfterLeave,</span>
<span class="code-block-extension-codeLine" data-line-num="14">    onLeaveCancelled,</span>
<span class="code-block-extension-codeLine" data-line-num="15">    onBeforeAppear,</span>
<span class="code-block-extension-codeLine" data-line-num="16">    onAppear,</span>
<span class="code-block-extension-codeLine" data-line-num="17">    onAfterAppear,</span>
<span class="code-block-extension-codeLine" data-line-num="18">    onAppearCancelled</span>
<span class="code-block-extension-codeLine" data-line-num="19">  } = props</span>
<span class="code-block-extension-codeLine" data-line-num="20">  </span>
<span class="code-block-extension-codeLine" data-line-num="21">  <span class="hljs-comment">// 定义调用钩子函数的方法</span></span>
<span class="code-block-extension-codeLine" data-line-num="22">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">callHook</span> = (<span class="hljs-params">hook, args</span>) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="23">    hook &amp;&amp;</span>
<span class="code-block-extension-codeLine" data-line-num="24">      <span class="hljs-title function_">callWithAsyncErrorHandling</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="25">        hook,</span>
<span class="code-block-extension-codeLine" data-line-num="26">        instance,</span>
<span class="code-block-extension-codeLine" data-line-num="27">        <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">TRANSITION_HOOK</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="28">        args</span>
<span class="code-block-extension-codeLine" data-line-num="29">      )</span>
<span class="code-block-extension-codeLine" data-line-num="30">  }</span>
<span class="code-block-extension-codeLine" data-line-num="31">  <span class="hljs-comment">// 钩子函数定义</span></span>
<span class="code-block-extension-codeLine" data-line-num="32">  <span class="hljs-keyword">const</span> hooks = {</span>
<span class="code-block-extension-codeLine" data-line-num="33">    mode,</span>
<span class="code-block-extension-codeLine" data-line-num="34">    persisted,</span>
<span class="code-block-extension-codeLine" data-line-num="35">    <span class="hljs-title function_">beforeEnter</span>(<span class="hljs-params">el</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="36">      <span class="hljs-keyword">let</span> hook = onBeforeEnter</span>
<span class="code-block-extension-codeLine" data-line-num="37">      <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="38">      <span class="hljs-comment">// 执行 onBeforeEnter</span></span>
<span class="code-block-extension-codeLine" data-line-num="39">      <span class="hljs-title function_">callHook</span>(hook, [el])</span>
<span class="code-block-extension-codeLine" data-line-num="40">    },</span>
<span class="code-block-extension-codeLine" data-line-num="41"></span>
<span class="code-block-extension-codeLine" data-line-num="42">    <span class="hljs-title function_">enter</span>(<span class="hljs-params">el</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="43">      <span class="hljs-keyword">let</span> hook = onEnter</span>
<span class="code-block-extension-codeLine" data-line-num="44">      <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="45">      <span class="hljs-comment">// 执行 onEnter</span></span>
<span class="code-block-extension-codeLine" data-line-num="46">      <span class="hljs-title function_">callAsyncHook</span>(hook, [el, done])</span>
<span class="code-block-extension-codeLine" data-line-num="47">    },</span>
<span class="code-block-extension-codeLine" data-line-num="48"></span>
<span class="code-block-extension-codeLine" data-line-num="49">    <span class="hljs-title function_">leave</span>(<span class="hljs-params">el, remove</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="50">      <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="51">      <span class="hljs-comment">// 执行 onBeforeLeave</span></span>
<span class="code-block-extension-codeLine" data-line-num="52">      <span class="hljs-title function_">callHook</span>(onBeforeLeave, [el])</span>
<span class="code-block-extension-codeLine" data-line-num="53">      <span class="hljs-keyword">const</span> done = (el.<span class="hljs-property">_leaveCb</span> = <span class="hljs-function">(<span class="hljs-params">cancelled?</span>) =&gt;</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="54">        <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="55">        <span class="hljs-comment">// 执行 onLeave</span></span>
<span class="code-block-extension-codeLine" data-line-num="56">        <span class="hljs-title function_">callAsyncHook</span>(onLeave, [el, done])</span>
<span class="code-block-extension-codeLine" data-line-num="57">      })</span>
<span class="code-block-extension-codeLine" data-line-num="58">    },</span>
<span class="code-block-extension-codeLine" data-line-num="59"></span>
<span class="code-block-extension-codeLine" data-line-num="60">    <span class="hljs-title function_">clone</span>(<span class="hljs-params">vnode</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="61">      <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolveTransitionHooks</span>(vnode, props, state, instance)</span>
<span class="code-block-extension-codeLine" data-line-num="62">    }</span>
<span class="code-block-extension-codeLine" data-line-num="63">  }</span>
<span class="code-block-extension-codeLine" data-line-num="64"></span>
<span class="code-block-extension-codeLine" data-line-num="65">  <span class="hljs-keyword">return</span> hooks</span>
<span class="code-block-extension-codeLine" data-line-num="66">}</span>
</code></pre>
<p>一个最基础的 <code>hooks</code> 主要包含 <code>beforeEnter</code>、<code>enter</code>、<code>leave</code> 这几个阶段，将会在 <code>patch</code> 的环节中被执行，执行的逻辑就是 <code>Vue</code> 官网上描述的逻辑。</p>
<p>另外，值得注意的是，除了这几个关键阶段之外，<code>Transiton</code> 还支持一个 <code>mode</code> 来指定动画的过渡时机，举个例子，如果 <code>mode === 'out-in'</code>，先执行离开动画，然后在其完成<strong>之后</strong>再执行元素的进入动画。那么这个时候就需要<strong>延迟渲染进入动画</strong>，则会为 <code>leavingHooks</code> 额外添加一个新的钩子：<code>afterLeave</code>，该钩子将会在离开后执行，表示着离开后再更新 <code>DOM</code>。</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">js</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"></span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">const</span> <span class="hljs-title class_">BaseTransitionImpl</span> = {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="hljs-comment">// ...</span></span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-keyword">if</span> (mode === <span class="hljs-string">'out-in'</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="6">      state.<span class="hljs-property">isLeaving</span> = <span class="hljs-literal">true</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">      <span class="hljs-comment">// 返回空的占位符节点，当离开过渡结束后，重新渲染组件</span></span>
<span class="code-block-extension-codeLine" data-line-num="8">      leavingHooks.<span class="hljs-property">afterLeave</span> = <span class="hljs-function">() =&gt;</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="9">        state.<span class="hljs-property">isLeaving</span> = <span class="hljs-literal">false</span></span>
<span class="code-block-extension-codeLine" data-line-num="10">        instance.<span class="hljs-title function_">update</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="11">      }</span>
<span class="code-block-extension-codeLine" data-line-num="12">      <span class="hljs-keyword">return</span> <span class="hljs-title function_">emptyPlaceholder</span>(child)</span>
<span class="code-block-extension-codeLine" data-line-num="13">    }</span>
<span class="code-block-extension-codeLine" data-line-num="14">  }</span>
<span class="code-block-extension-codeLine" data-line-num="15">}</span>
</code></pre>
<h2 data-id="heading-5">总结</h2>
<p>本小节我们核心介绍了 <code>Transition</code> 内置组件的实现原理：</p>
<ol>
<li><code>Transition</code> 组件本身是一个无状态组件，内部本身不渲染任何额外的 <code>DOM</code> 元素，<code>Transition</code> 渲染的是组件嵌套的第一个子元素节点。</li>
<li>如果子元素是应用了 <code>CSS</code> 过渡或动画，<code>Transition</code> 组件会在子元素节点渲染适当时机，动态为子元素节点增加或删除对应的 <code>class</code>。</li>
<li>如果有为 <code>Transition</code> 定义一些钩子函数，那么这些钩子函数会被合入到子节点的关键生命周期 <code>beforeEnter</code>、<code>enter</code>、<code>leave</code> 中调用执行，通过 <code>setTransitionHooks</code> 被设置到子节点的 <code>transition</code> 属性中。</li>
</ol></div>
    </body>
    </html>